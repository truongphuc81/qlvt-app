<!DOCTYPE html>
<html>
<head>
  <title>Phiếu Mượn/Trả Vật Tư</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  
  <link rel="stylesheet" href="styles.css?v=2">
  <link rel="stylesheet" href="manager-desktop.css"> <!-- Use the dashboard layout -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <link rel="icon" href="/logo.png" type="image/png">
  <link rel="apple-touch-icon" href="/logo.png">

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyAYiUIRQE1l-snjrZM7TJdp8YE7X8MMpEw",
        authDomain: "quan-ly-vat-tu-backend.firebaseapp.com",
        projectId: "quan-ly-vat-tu-backend",
        storageBucket: "quan-ly-vat-tu-backend.firebasestorage.app",
        messagingSenderId: "323292129107",
        appId: "1:323292129107:web:8e467d10c217197b9b63a6",
        measurementId: "G-N3VLYSXTR8"
    };
    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const auth = firebaseApp.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    const db = firebase.firestore(); 
  </script>
</head>
<body>

<div class="app-layout">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="logo.png" alt="Logo" class="sidebar-logo">
            <span class="sidebar-brand-text">KTV Dashboard</span>
        </div>

        <!-- Moved User Profile to Top for better visibility on mobile -->
        <div class="sidebar-user-section p-3 border-bottom bg-light">
             <button id="authButton" class="btn-login" style="display:none; width:100%;">Đăng nhập bằng Gmail</button>
             <div id="userProfile" style="display:block;"> 
                <div style="font-weight:bold; font-size:14px; margin-bottom:5px;" id="sidebarUserName">Khách</div>
                <button id="signOutButton" class="btn-logout w-100" style="display:none;" onclick="firebase.auth().signOut().then(() => { window.location.reload(); })">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
             </div>
        </div>

        <nav class="sidebar-menu">
            <div class="menu-category">Tổng quan</div>
            <button id="nav-dashboard" class="nav-link active" onclick="switchView('view-dashboard', this)">
                <i class="fas fa-home"></i> Tổng quan
            </button>

            <div class="menu-category">Tác vụ</div>
            <button id="nav-transactions" class="nav-link" onclick="switchView('view-transactions', this)">
                <i class="fas fa-exchange-alt"></i> Mượn / Trả
            </button>
            <button id="nav-reconciliation" class="nav-link" onclick="switchView('view-reconciliation', this)">
                <i class="fas fa-check-double"></i> Đối chiếu sổ 3 liên
            </button>

            <div class="menu-category">Hệ thống</div>
            <div id="managerPageButtonWrapper" style="display:none;">
                <button onclick="window.location.href='manager.html'" class="nav-link" style="color: var(--primary-color);">
                    <i class="fas fa-user-shield"></i> Trang Quản Lý
                </button>
            </div>
            <a href="auditor.html" id="nav-auditor-link" class="nav-link" style="display:none;">
                <i class="fas fa-clipboard-check"></i> Xem Lịch sử Kho
            </a>
        </nav>

    </aside>

    <!-- Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- HEADER -->
        <header class="top-header">
            <div style="display:flex; align-items:center;">
                <button class="btn-icon-only mobile-menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="header-title" id="pageTitle">Tổng quan</h2>
            </div>
            
            <div class="header-actions">
                <button id="darkModeToggle" onclick="toggleDarkMode()" class="btn-icon-only" title="Giao diện tối">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <div id="infoSpinner" style="display:none;text-align:center; padding: 20px;">
            <div class="spinner"></div><p>Đang tải...</p>
        </div>

        <div class="content-body" id="mainPage" style="display:none;">
            
            <!-- VIEW 1: DASHBOARD (TỔNG QUAN) -->
            <div id="view-dashboard" class="view-section active">
                <div class="form-section">
                  <h3>Thông tin chung</h3>
                  <div class="user-profile">
                    <img id="userAvatar" src="default-avatar.png" alt="Avatar" class="avatar-img">
                    <div class="user-details">
                      <h3 id="technicianName">Loading...</h3>
                      <p id="userEmail">Loading...</p>
                    </div>
                  </div>
                  <div id="infoSuccessMessage" class="success" style="display:none; margin-top: 15px;"></div>
                  <div id="infoErrorMessage" class="error" style="display:none; margin-top: 15px;"></div>
                </div>

                <div id="reconciliation-notification" class="reconciliation-notification" style="display:none; text-align: center; padding: 15px; background-color: #ffc107; color: #333; margin-bottom: 24px; border-radius: 8px; font-weight:bold;"></div>

                <div class="form-section">
                  <h3>Tổng quan mặt hàng đã mượn</h3>
                  <div id="overviewContent"> 
                    <table id="overviewTable">
                      <thead> 
                        <tr><th>Tên vật tư</th><th style="text-align: center;">Tổng mượn</th><th style="text-align: center;">Tổng sử dụng</th><th style="text-align: center;">Đã trả</th> <th style="text-align: center;">Còn lại</th></tr>
                      </thead>
                      <tbody id="overviewBody"></tbody>
                    </table>
                    <div id="overviewSpinner" style="display:none;text-align:center;">...</div>
                  </div>
                </div>
            </div>

                <!-- VIEW 2: TRANSACTIONS (MƯỢN/TRẢ) -->
            <div id="view-transactions" class="view-section">
                <!-- Borrow -->
                <div class="form-section">
                  <h3>Mượn hàng</h3>
                  <div id="borrowContent"> 
                    <label>Nội dung mượn hàng (hoặc mô tả lỗi/công việc để AI gợi ý):</label><br>
                    <textarea id="borrowItems" placeholder="VD: 2 mực 12A, 3 mực 26A hoặc 'Máy tính Dell không lên nguồn'"></textarea><br>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button id="submitBorrowButton" onclick="submitBorrowForm()" style="flex: 2;">Gửi Yêu Cầu Mượn</button>
                        <button id="aiSuggestButton" onclick="suggestItemsWithAI()" style="flex: 1; background-color: #6200ee; color: white;">
                            <i class="fas fa-robot"></i> AI Gợi ý
                        </button>
                    </div>
                    <div id="aiSuggestSpinner" style="display:none;text-align:center; color: #6200ee; margin-bottom: 10px;">
                        <i class="fas fa-spinner fa-spin"></i> AI đang phân tích...
                    </div>
                    <div id="borrowSpinner" style="display:none;text-align:center;">...</div>
                    <div id="borrowSuccessMessage" class="success" style="display:none;"></div>
                    <div id="borrowErrorMessage" class="error" style="display:none;"></div>
                  </div>
                </div>

                <!-- Return -->
                <div class="form-section toggle-section">
                  <h3 class="toggle-header collapsible">Trả vật tư không sử dụng</h3>
                  <div id="returnContent" class="toggle-content collapsible-content" style="display: none;">
                    <p class="form-hint">Chỉ hiển thị các vật tư bạn đang nợ (số lượng còn lại > 0).</p>
                    <table id="ktvReturnItemsTable">
                      <thead>
                        <tr><th>Tên vật tư</th><th>Đang nợ</th><th>Số lượng trả</th></tr>
                      </thead>
                      <tbody id="ktvReturnItemsBody"><tr><td colspan="3">Đang tải danh sách...</td></tr></tbody>
                    </table>
                    <label for="ktvReturnNote" style="margin-top: 15px;">Ghi chú (Tùy chọn):</label><br>
                    <textarea id="ktvReturnNote" placeholder="VD: Trả hàng thừa, hàng lỗi..." style="height: 80px;"></textarea><br>
                    <button id="submitKtvReturnButton" onclick="submitKtvReturnItems()">Xác nhận Trả hàng</button>
                    <div id="ktvReturnSpinner" style="display:none;text-align:center;">...</div>
                    <div id="ktvReturnSuccessMessage" class="success" style="display:none;"></div>
                    <div id="ktvReturnErrorMessage" class="error" style="display:none;"></div>
                    </div>
                </div>

                <!-- History (Moved here) -->
                <div class="form-section" id="ktvHistorySection"> 
                  <h3>Lịch sử Giao dịch</h3> 
                  <div id="ktvHistoryContent"> 
                    <label for="ktvHistoryFilterType">Lọc theo loại:</label>
                    <select id="ktvHistoryFilterType" onchange="renderKtvHistoryTable()"><option value="Tất cả">Tất cả</option><option value="Mượn">Mượn</option><option value="Trả">Trả</option></select>
                    <div id="ktvHistorySpinner" style="display:none; text-align:center;">...</div>
                    <table id="ktvHistoryTable">
                      <thead>
                        <tr><th>Thời gian</th><th>Loại</th><th>Nội dung</th></tr>
                      </thead>
                      <tbody id="ktvHistoryBody"><tr><td colspan="3">Đang tải...</td></tr></tbody>
                    </table>
                    <button id="loadMoreKtvHistory" class="load-more-button" onclick="loadMoreKtvHistory()" style="display:none;">Tải thêm</button>
                  </div>
                </div>
            </div>

            <!-- VIEW 3: RECONCILIATION (ĐỐI SOÁT) -->
            <div id="view-reconciliation" class="view-section">
                <div class="form-section">
                  <div id="reconcileContent"> 
                    <h4 class="text-primary">Số sổ chưa đối chiếu</h4>
                    <table id="borrowedItemsTable">
                      <thead> 
                        <tr><th>Số sổ</th><th>Vật tư & SL</th><th>Xác nhận</th></tr>
                      </thead>
                      <tbody id="borrowedItemsBody"></tbody>
                    </table>
                    <!-- <button id="loadMoreUnreconciled" ... hidden by js ...> -->
                    <button id="submitReturnButton" onclick="submitReturnForm()">Xác nhận đối chiếu</button>
                    <button onclick="showErrorReportForm()" style="background-color: var(--secondary-color);">Báo cáo sai sót</button>
                    <div id="returnSpinner" style="display:none;text-align:center;">...</div>
                    <div id="returnSuccessMessage" class="success" style="display:none;"></div>
                    <div id="returnErrorMessage" class="error" style="display:none;"></div>

                    <div id="errorReportForm" class="form-section" style="display:none; margin-top: 20px; border: 1px solid var(--error-color);">
                        <h3 style="color: var(--error-color);">Báo cáo sai sót</h3>
                        <label for="errorType">Loại sai sót:</label>
                        <select id="errorType">
                            <option value="Số sổ sai">Số sổ sai</option>
                            <option value="Vật tư sai">Vật tư sai</option>
                            <option value="Số lượng sai">Số lượng sai</option>
                            <option value="Khác">Khác</option>
                        </select><br>
                        <label for="relatedTicketOrDate">Số sổ hoặc Ngày liên quan:</label>
                        <input type="text" id="relatedTicketOrDate" placeholder="VD: Sổ 123 hoặc 01/10/2025"><br>
                        <label for="errorDescription">Mô tả sai sót:</label>
                        <textarea id="errorDescription" style="height: 100px;"></textarea><br>
                        <label for="suggestedFix">Đề xuất sửa (Nếu có):</label>
                        <textarea id="suggestedFix" style="height: 60px;"></textarea><br>
                        <button onclick="submitErrorReport()">Gửi Báo cáo</button>
                        <button onclick="hideErrorReportForm()" style="background-color: #ccc; color: #333;">Hủy</button>
                        <div id="errorReportSpinner" style="display:none;text-align:center;"><div class="spinner"></div></div>
                        <div id="errorReportSuccessMessage" class="success" style="display:none;"></div>
                        <div id="errorReportErrorMessage" class="error" style="display:none;"></div>
                    </div>

                    <div id="reconciledTicketsSection" style="margin-top: 30px;">
                      <h4 class="text-success">Sổ 3 liên đã đối chiếu</h4>
                      <table id="reconciledTicketsTable">
                        <thead> 
                          <tr><th>Số sổ</th><th>Vật tư & SL</th></tr>
                        </thead>
                        <tbody id="reconciledTicketsBody"></tbody>
                      </table>
                      <button id="loadMoreReconciled" class="load-more-button" onclick="loadMoreReconciledTickets()">Tải thêm</button>
                    </div>
                  </div>
                </div>
            </div>


        </div>
    </main>
</div>

<script src="common.js"></script> 
<script src="app.js?v=3"></script> 
</body>
</html>
