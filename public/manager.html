<!DOCTYPE html>
<html>
<head>
  <title>Trang Quản Lý Vật Tư</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  
  <!-- CSS -->
  <link rel="stylesheet" href="styles.css?v=2">
  <link rel="stylesheet" href="manager-desktop.css"> <!-- New Desktop UI -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <link rel="icon" href="/logo.png" type="image/png">
  <link rel="apple-touch-icon" href="/logo.png">

  <!-- Libraries -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  
  <script>
    // Firebase Config (Keep existing logic)
    const firebaseConfig = {
        apiKey: "AIzaSyAYiUIRQE1l-snjrZM7TJdp8YE7X8MMpEw",
        authDomain: "quan-ly-vat-tu-backend.firebaseapp.com",
        projectId: "quan-ly-vat-tu-backend",
        storageBucket: "quan-ly-vat-tu-backend.firebasestorage.app",
        messagingSenderId: "323292129107",
        appId: "1:323292129107:web:8e467d10c217197b9b63a6",
        measurementId: "G-N3VLYSXTR8"
    };
    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const auth = firebaseApp.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    const db = firebase.firestore(); 
  </script>
</head>
<body>

<div class="app-layout">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="logo.png" alt="Logo" class="sidebar-logo">
            <span class="sidebar-brand-text">QLVT Admin</span>
        </div>

        <nav class="sidebar-menu">
            <div class="menu-category">Tổng quan</div>
            <button id="nav-dashboard" class="nav-link active" onclick="switchView('view-dashboard', this)">
                <i class="fas fa-chart-pie"></i> Dashboard
            </button>

            <div class="menu-category">Quản lý</div>
            <button id="nav-transactions" class="nav-link" onclick="switchView('view-transactions', this)">
                <i class="fas fa-users-cog"></i> Kỹ thuật viên
            </button>
            <button id="nav-inventory" class="nav-link" onclick="switchView('view-inventory', this)">
                <i class="fas fa-boxes"></i> Kho & Vật tư
            </button>

            <div class="menu-category">Báo cáo & Hệ thống</div>
            <button id="nav-reports" class="nav-link" onclick="switchView('view-reports', this)">
                <i class="fas fa-file-invoice"></i> Lịch sử & Báo cáo
            </button>
            <button id="nav-import" class="nav-link" onclick="switchView('view-import', this)">
                <i class="fas fa-file-import"></i> Nhập Dữ liệu
            </button>
            <button id="nav-system" class="nav-link" onclick="switchView('view-system', this)">
                <i class="fas fa-cogs"></i> Phân quyền
            </button>
            
            <div class="menu-category">Khác</div>
            <a href="repair.html" class="nav-link">
                <i class="fas fa-tools"></i> Sửa chữa
            </a>
            <a href="reconciliation.html" class="nav-link">
                <i class="fas fa-balance-scale"></i> Đối soát
            </a>
            <a href="history.html" class="nav-link">
                <i class="fas fa-history"></i> Lịch sử cá nhân
            </a>
            <a href="borrow-return.html" class="nav-link">
                <i class="fas fa-exchange-alt"></i> Mượn/Trả (Cũ)
            </a>
            <a href="inventory-audit.html" class="nav-link">
                <i class="fas fa-clipboard-check"></i> Kiểm kê kho
            </a>
            <a href="qr-generator.html" class="nav-link">
                <i class="fas fa-qrcode"></i> In mã QR
            </a>
            <a href="index.html" class="nav-link" style="color: var(--secondary-color);">
                <i class="fas fa-arrow-left"></i> Về trang KTV
            </a>
        </nav>

        <div class="sidebar-footer">
             <button id="authButton" class="btn-login" style="display:none;">Đăng nhập</button>
             <div id="userProfile" style="display:none;">
                <div style="font-weight:bold; font-size:14px; margin-bottom:5px;" id="sidebarUserName">User</div>
                <button id="signOutButton" class="btn-logout" onclick="firebase.auth().signOut().then(() => { window.location.href = 'index.html'; })">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
             </div>
        </div>
    </aside>

    <!-- Overlay for mobile -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- TOP HEADER -->
        <header class="top-header">
            <div style="display:flex; align-items:center;">
                <button class="btn-icon-only mobile-menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="header-title" id="pageTitle">Dashboard</h2>
            </div>
            
            <div class="header-actions">
                <button id="darkModeToggle" onclick="toggleDarkMode()" class="btn-icon-only" title="Giao diện tối">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <!-- CONTENT BODY -->
        <div class="content-body" id="managerPage" style="display:none;"> <!-- Initially hidden until auth -->
            
            <!-- VIEW 1: DASHBOARD -->
            <div id="view-dashboard" class="view-section active">
                <div id="managerNotificationArea" class="form-section" style="display: none; background-color: #fff3cd; border-color: #ffeeba;">
                    <h4><span style="color: #856404;"><i class="fas fa-bell"></i> Thông báo yêu cầu đang chờ:</span></h4>
                    <p id="pendingCountsText" style="color: #856404; font-weight: bold;"></p>
                    <div id="notificationSpinner" style="display:none;"><div class="spinner"></div></div>
                </div>

                <div id="globalOverviewSection" class="form-section">
                    <h3 class="toggle-header active">Tổng quan Toàn hệ thống</h3>
                    <div class="toggle-content">
                        <p class="form-hint">Tổng hợp số lượng mượn/trả/sử dụng của TẤT CẢ kỹ thuật viên.</p>
                        <table id="globalOverviewTable">
                          <thead> 
                            <tr>
                              <th>Tên vật tư</th>
                              <th>Mã vật tư</th>
                              <th>Tổng mượn</th>
                              <th>Tổng sử dụng</th>
                              <th>Tổng trả</th>
                              <th>Tổng còn nợ (Toàn kho)</th>
                              <th>KTV đang nợ</th>
                            </tr>
                          </thead>
                          <tbody id="globalOverviewBody">
                            <tr><td colspan="7">Nhấn để mở và tải...</td></tr>
                          </tbody>
                        </table>
                        <div id="globalOverviewSpinner" style="display:none; text-align:center; margin-top: 15px;">
                          <div class="spinner"></div>
                          <p>Đang tổng hợp dữ liệu toàn hệ thống, vui lòng chờ...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: TRANSACTIONS (TECHNICIAN MANAGEMENT) -->
            <div id="view-transactions" class="view-section">
                <!-- Select Technician -->
                <div class="form-section">
                  <h3><i class="fas fa-user-cog"></i> Chọn kỹ thuật viên làm việc</h3>
                  <div style="display:flex; gap:10px;">
                      <select id="technicianEmail" onchange="loadTechnicianData()">
                        <option value="">Chọn kỹ thuật viên</option>
                      </select>
                  </div>
                  <div id="technicianSpinner" style="display:none;text-align:center; margin-top:10px;">...</div>
                  <div id="technicianSuccessMessage" class="success" style="display:none;"></div>
                  <div id="technicianErrorMessage" class="error" style="display:none;"></div>
                </div>

                <!-- Technician Overview -->
                <div id="managerOverviewSection" class="form-section">
                  <h3 class="toggle-header active">Tổng quan mặt hàng (KTV đang chọn)</h3>
                  <div class="toggle-content">
                    <table id="managerOverviewTable">
                      <thead> 
                        <tr>
                          <th>Tên vật tư</th><th>Mã vật tư</th><th>Tổng mượn</th><th>Tổng sử dụng</th><th>Đã trả</th> <th>Còn lại</th> <th>Chi tiết số sổ</th><th>Hành động</th>
                        </tr>
                      </thead>
                      <tbody id="managerOverviewBody"></tbody>
                    </table>
                    <button id="fix-all-negative-btn" 
                      onclick="fixAllNegativeItems()" 
                      style="background-color: var(--error-color); display:none; margin-top: 15px; width: 100%; max-width: 500px;">Sửa Tất Cả Vật Tư Bị Âm (Về 0)</button>
                    <div id="managerOverviewSpinner" style="display:none;text-align:center;">...</div>
                  </div>
                </div>

                <!-- Borrow/Return Form -->
                <div id="managerBorrowForm" class="form-section">
                  <h3 class="toggle-header active">Giao dịch Mượn / Trả</h3>
                  <div class="toggle-content">
                    <div class="borrow-layout">
                      <!-- Left Panel -->
                      <div class="left-panel">
                        <div class="mode-tabs">
                          <div id="tab-borrow" class="mode-tab active" onclick="selectMode('borrow')">NHẬP MƯỢN</div>
                          <div id="tab-return" class="mode-tab" onclick="selectMode('return')">NHẬP TRẢ</div>
                        </div>
                        
                        <input type="radio" name="managerMode" id="borrowMode" checked style="display:none">
                        <input type="radio" name="managerMode" id="returnUnusedMode" style="display:none">

                        <div id="borrowLeftControls">
                          <div class="control-group">
                              <label class="toggle-switch-label" style="font-weight: bold; display: flex; align-items: center; gap: 10px;">
                                  <input type="checkbox" id="directBorrow" onchange="toggleBorrowInput()"> 
                                  <span>Nhập trực tiếp (Không cần lệnh từ KTV)</span>
                              </label>
                          </div>
                    
                              <div id="borrowNoteSelectDiv" class="control-group" style="background-color: #fff3cd; border: 1px dashed #ffeeba;">
                                  <label style="color: #856404; font-weight: bold;">Chọn lệnh mượn từ KTV:</label>
                                  <select id="borrowNoteSelect" onchange="displaySelectedNote()" style="width: 100%; margin-bottom: 10px; padding: 8px;">
                                      <option value="">-- Chọn lệnh mượn --</option>
                                  </select>
                                  
                                  <label style="font-size: 0.9em; color: #666;">Ghi chú của KTV:</label>
                                  <textarea id="technicianNote" readonly rows="2" style="width: 100%; font-size: 13px; background: #fff; border: 1px solid #ddd;"></textarea>
                              </div>
                    
                              <div id="directBorrowNoteDiv" class="control-group" style="display:none;">
                                  <label>Ghi chú mượn trực tiếp:</label>
                                  <textarea id="managerBorrowNote" rows="2" style="width: 100%;" placeholder="VD: Xuất cho NHCS"></textarea>
                              </div>
                          </div>

                        <div id="returnLeftControls" style="display:none;">
                            <div class="control-group">
                                 <label>Chọn lệnh trả (Nếu có):</label>
                                 <select id="returnNoteSelect" onchange="displaySelectedReturnNote()" style="width: 100%; margin-bottom: 10px;">
                                    <option value="">-- Trả trực tiếp --</option>
                                 </select>
                                 
                                 <label style="font-size: 0.9em; color: #666;">Ghi chú trả của KTV:</label>
                                 <textarea id="technicianReturnNote" readonly rows="3" style="font-size: 13px; background: #f8f9fa; border: 1px solid #eee;"></textarea>
                            </div>
                        </div>
                      </div>

                      <!-- Right Panel -->
                      <div class="right-panel">
                        
                        <!-- BORROW RIGHT PANEL -->
                        <div id="borrowRightPanel">
                            <div class="control-group" style="padding: 10px;">
                                <div class="input-row">
                                    <input type="text" id="managerItemSearch" placeholder="Nhập mã hoặc tên vật tư..." style="flex-grow: 2;">
                                    <button class="btn-icon" onclick="startQrScanner()" title="Quét mã QR" style="width: auto;"><i class="fas fa-qrcode"></i></button>
                                </div>
                                <div class="input-row" style="margin-top: 10px;">
                                    <input type="number" id="managerItemQuantity" placeholder="Số lượng" min="1" style="flex-grow: 1;">
                                    <button onclick="addManagerItem()" class="btn-add" title="Thêm vào danh sách" style="flex-grow: 0; min-width: 80px; background-color: var(--primary-color) !important;">Thêm</button>
                                </div>
                            </div>
                            <div id="managerBorrowSuccessMessage" class="success" style="display:none; margin-top:10px;"></div>
                            <div id="managerBorrowErrorMessage" class="error" style="display:none; margin-top:10px;"></div>
                            <div class="table-scroll-container">
                                <table id="managerSelectedItemsTable">
                                    <thead><tr><th>Mã</th><th>Tên</th><th style="width: 60px; text-align: center;">SL</th><th style="width: 50px;">Xóa</th></tr></thead>
                                    <tbody id="managerSelectedItemsBody"></tbody>
                                </table>
                            </div>

                            <div class="action-footer">
                                <div style="flex-grow: 1; margin-right: 10px;">
                                    <input type="text" id="managerTransactionDate" placeholder="Ngày (để trống = hôm nay)" style="display:none;">
                                    <textarea id="borrowRejectionReason" placeholder="Nhập lý do từ chối..." style="height: 40px; width: 100%; display:none; margin-bottom: 0; font-size: 13px;"></textarea>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <button onclick="submitManagerBorrow()" style="margin: 0; height: 40px;">Duyệt & Gửi</button>
                                    <button onclick="toggleRejectInput('borrow')" style="margin: 0; background-color: var(--error-color) !important; font-size: 12px; padding: 5px;">Từ chối</button>
                                </div>
                            </div>
                            
                            <div id="managerBorrowSpinner" style="display:none;text-align:center; margin-top:10px;">...</div>
                        </div>

                        <!-- RETURN RIGHT PANEL -->
                        <div id="returnRightPanel" style="display:none;">
                             <div class="table-scroll-container" style="max-height: 250px;">
                                <table id="unusedItemsTable">
                                  <thead>
                                    <tr>
                                      <th>Tên VT</th>
                                      <th>Mã VT</th>
                                      <th style="text-align: center;">Nợ</th>
                                      <th style="width: 100px;">SL Trả</th> 
                                      </tr>
                                  </thead>
                                  <tbody id="unusedItemsBody"><tr><td colspan="4">Vui lòng chọn Kỹ thuật viên</td></tr></tbody>
                                </table>
                             </div>

                             <button onclick="addSelectedItemsToReturnList()" 
                                     style="width: 100%; margin-top: 5px; margin-bottom: 15px; background-color: var(--primary-color); height: 45px;">
                                ↓ Thêm các mục đã nhập vào danh sách
                             </button>
                             <div id="directReturnControls" style="margin-top: 15px; border-top: 2px dashed #eee; padding-top: 15px;">
                                <h4 style="font-size: 14px; margin: 0 0 10px 0; color: var(--success-color);">Danh sách xác nhận trả:</h4>
                                        <div class="table-scroll-container" style="max-height: 150px;">
                                            <table id="managerReturnListTable">
                                                <thead><tr><th>Tên</th><th>Mã</th><th>SL Trả</th><th>Xóa</th></tr></thead>
                                                <tbody id="managerReturnListBody"><tr><td colspan="4">Chưa có vật tư nào.</td></tr></tbody>
                                            </table>
                                        </div>
                                        
                                        <div class="action-footer">
                                             <div style="flex-grow: 1; margin-right: 10px;">
                                                <textarea id="returnRejectionReason" placeholder="Lý do từ chối..." style="height: 40px; width: 100%; display:none; margin-bottom: 5px; font-size: 13px;"></textarea>
                                                <textarea id="managerReturnNote" placeholder="Ghi chú trả hàng (Tùy chọn)..." style="height: 40px; width: 100%; font-size: 13px; margin-bottom: 5px;"></textarea>

                                                <div style="display: flex; gap: 10px;">
                                                    <input type="text" id="directReturnDate" placeholder="Ngày trả (DD/MM/YYYY)" style="flex: 1; margin-bottom: 0; height: 35px;" autocomplete="off">
                                                    <input type="text" id="approveReturnDate" style="display:none;"> 
                                                </div>
                                             </div>
                                             <div id="returnActionButtons" style="display: flex; flex-direction: column; gap: 5px;">
                                                <button onclick="handleReturnSubmit()" style="margin: 0; height: 40px;">Xác nhận</button>
                                                <button onclick="toggleRejectInput('return')" style="margin: 0; background-color: var(--error-color) !important; font-size: 12px; padding: 5px;">Từ chối</button>
                                             </div>
                                        </div>
                                     </div>
                                     
                                     <div id="returnUnusedSpinner" style="display:none;text-align:center; margin-top:10px;">...</div>
                                     <div id="returnUnusedSuccessMessage" class="success" style="display:none; margin-top:10px;"></div>
                                     <div id="returnUnusedErrorMessage" class="error" style="display:none; margin-top:10px;"></div>
                        </div>

                      </div> 
                    </div> 
                  </div>
                </div>

                <!-- Transfer Items -->
                <div id="transferForm" class="form-section">
                  <h3 class="toggle-header active">Chuyển vật tư (Toàn hệ thống)</h3>
                  <div class="toggle-content">
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                      <div style="flex: 1; min-width: 250px;">
                        <label for="transferFromTech">Từ Kỹ thuật viên:</label><br>
                        <select id="transferFromTech" onchange="loadTransferableItems()"><option value="">-- Chọn người chuyển --</option></select>
                      </div>
                      <div style="flex: 1; min-width: 250px;">
                        <label for="transferToTech">Đến Kỹ thuật viên:</label><br>
                        <select id="transferToTech"><option value="">-- Chọn người nhận --</option></select>
                      </div>
                    </div>
                    <h4>Vật tư có thể chuyển (của người chuyển)</h4>
                    <table id="transferItemsTable">
                      <thead>
                        <tr><th>Tên vật tư</th><th>Mã vật tư</th><th>Đang nợ</th><th>Số lượng chuyển</th></tr>
                      </thead>
                      <tbody id="transferItemsBody"><tr><td colspan="4">Vui lòng chọn Kỹ thuật viên chuyển</td></tr></tbody>
                    </table>
                    <label for="transferDate">Ngày chuyển:</label><br>
                    <input type="text" id="transferDate" placeholder="DD/MM/YYYY" required><br> 
                    <button id="submitTransferButton" onclick="submitTransfer()">Xác nhận chuyển</button>
                    <div id="transferSpinner" style="display:none; text-align:center;">...</div>
                    <div id="transferSuccessMessage" class="success" style="display:none;"></div>
                    <div id="transferErrorMessage" class="error" style="display:none;"></div>
                  </div>
                </div>

                <!-- Ticket Ranges -->
                <div id="ticketRangeForm" class="form-section">
                  <h3 class="toggle-header active">Quản lý dải số sổ (KTV đã chọn)</h3>
                  <div class="toggle-content">
                    <label>Số bắt đầu:</label><br>
                    <input type="number" id="ticketRangeStart" class="ticket-range-input" min="1" placeholder="VD: 1"><br>
                    <label>Số kết thúc:</label><br>
                    <input type="number" id="ticketRangeEnd" class="ticket-range-input" min="1" placeholder="VD: 100"><br>
                    <button onclick="addTicketRange()">Thêm dải số</button><br>
                    <h4>Danh sách dải số sổ</h4>
                    <table id="ticketRangesTable">
                      <thead>
                        <tr><th>Số bắt đầu</th><th>Số kết thúc</th><th>Xóa</th></tr>
                      </thead>
                      <tbody id="ticketRangesBody"></tbody>
                    </table>
                    <button onclick="saveTicketRanges()">Lưu dải số sổ</button>
                    <div id="ticketRangeSpinner" style="display:none;text-align:center;">...</div>
                    <div id="ticketRangeSuccessMessage" class="success" style="display:none;"></div>
                    <div id="ticketRangeErrorMessage" class="error" style="display:none;"></div>
                  </div>
                </div>
            </div>

            <!-- VIEW 3: INVENTORY -->
            <div id="view-inventory" class="view-section">
                <!-- Check Item Info -->
                <div id="itemInfoSection" class="form-section">
                  <h3 class="toggle-header active">Kiểm tra thông tin vật tư</h3>
                  <div class="toggle-content">
                    <p class="form-hint">Kiểm tra thông tin vật tư bằng Mã, Tên hoặc quét mã QR.</p>
                    <div class="input-row">
                        <input type="text" id="itemInfoSearchInput" placeholder="Nhập mã hoặc tên vật tư..." style="flex-grow: 2;">
                        <button class="btn-icon" onclick="startQrScanner('info')" title="Quét mã QR để kiểm tra" style="width: auto;"><i class="fas fa-qrcode"></i></button>
                    </div>
                    <button onclick="checkItemInfo()" class="btn-add" style="width: 100%; margin-top: 10px; height: 45px;">Kiểm tra</button>
                    <div id="itemInfoResultArea" style="margin-top: 15px;"></div>
                    <div id="itemInfoSpinner" style="display:none; text-align:center; margin-top: 15px;">
                        <div class="spinner"></div>
                    </div>
                  </div>
                </div>

                <!-- New Item -->
                <div id="newItemSection" class="form-section">
                  <h3 class="toggle-header active">Tạo Vật Tư Mới</h3>
                  <div class="toggle-content">
                    <p class="form-hint">Tạo một mã vật tư mới trong hệ thống.</p>
                    <div class="control-group">
                      <label for="newItemCode">Mã vật tư mới (VD: MUC-IN-HP-26A):</label>
                      <input type="text" id="newItemCode" placeholder="Mã không dấu, không khoảng trắng, viết hoa">
                    </div>
                    <div class="control-group">
                      <label for="newItemName">Tên vật tư mới:</label>
                      <input type="text" id="newItemName" placeholder="VD: Mực in HP 26A">
                    </div>
                    <div class="control-group">
                      <label for="newItemUnit">Đơn vị tính:</label>
                      <input type="text" id="newItemUnit" placeholder="VD: Hộp, Cái, Chiếc">
                    </div>
                    <div class="control-group">
                      <label for="newItemGroup">Nhóm vật tư:</label>
                      <input type="text" id="newItemGroup" placeholder="VD: Mực in, Linh kiện máy tính">
                    </div>
                    <div class="control-group">
                      <label for="newItemUnitPrice">Đơn giá (VNĐ):</label>
                      <input type="number" id="newItemUnitPrice" placeholder="VD: 350000">
                    </div>
                    <button onclick="submitNewItem()">Lưu Vật Tư Mới</button>
                    <div id="newItemSpinner" style="display:none;text-align:center; margin-top: 15px;"><div class="spinner"></div></div>
                    <div id="newItemSuccessMessage" class="success" style="display:none;"></div>
                    <div id="newItemErrorMessage" class="error" style="display:none;"></div>
                  </div>
                </div>
                
                <!-- Inventory Upload -->
                <div id="inventoryUploadSection" class="form-section">
                  <h3 class="toggle-header active">Tải lên Danh mục Vật tư (Excel)</h3>
                  <div class="toggle-content">
                    <p class="form-hint">Tải lên file Excel chứa danh mục vật tư tổng. Các cột bắt buộc: 'Mã hàng', 'Tên hàng', 'Đơn vị tính', 'Số lượng', 'Giá trị'.</p>
                    <input type="file" id="inventoryFile" accept=".xlsx,.xls" style="margin-bottom: 10px;"><br>
                    <button onclick="handleInventoryUpload()">Tải lên và Xem trước</button><br>
                    
                    <div id="inventoryUploadSpinner" style="display:none; text-align:center; margin-top: 15px;">
                        <div class="spinner"></div>
                        <p>Đang xử lý file...</p>
                    </div>

                    <div id="inventoryPreviewArea" style="display:none; margin-top: 15px;">
                        <p><strong>Xem trước dữ liệu:</strong> <span id="inventoryRowCount"></span> vật tư. Vui lòng kiểm tra kỹ trước khi xác nhận.</p>
                        <div class="table-scroll-container" style="max-height: 400px;">
                            <table id="inventoryPreviewTable">
                                <thead> 
                                    <tr>
                                        <th>Nhóm VTHH</th>
                                        <th>Mã hàng</th>
                                        <th>Tên hàng</th>
                                        <th>ĐVT</th>
                                        <th>Số lượng</th>
                                        <th>Giá trị</th>
                                        <th>Đơn giá (tự tính)</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryPreviewBody"></tbody>
                            </table>
                        </div>
                        <button id="confirmInventoryUploadBtn" onclick="confirmInventoryUpload()" style="margin-top: 15px; background-color: var(--primary-color);">Xác nhận và Lưu vào Kho</button>
                    </div>
                    
                    <div id="inventoryUploadSuccessMessage" class="success" style="display:none;"></div>
                    <div id="inventoryUploadErrorMessage" class="error" style="display:none;"></div>
                  </div>
                </div>
            </div>

            <!-- VIEW 4: REPORTS -->
            <div id="view-reports" class="view-section">
                <div id="managerHistorySection" class="form-section"> 
                  <h3><i class="fas fa-history"></i> Lịch sử Giao dịch (Thời gian thực)</h3>
                  <label for="managerHistoryFilterType">Lọc theo loại:</label> <select id="managerHistoryFilterType" onchange="listenForManagerHistory()"> <option value="Tất cả">Tất cả</option><option value="Mượn">Mượn</option><option value="Trả">Trả</option></select>
                  <label for="managerHistoryFilterTech">Lọc theo Kỹ thuật viên:</label> <select id="managerHistoryFilterTech" onchange="listenForManagerHistory()"> <option value="Tất cả">Tất cả KTV</option></select>
                  <div id="managerHistorySpinner" style="display:none; text-align:center;"> ... </div>
                  <table id="managerHistoryTable"> 
                    <thead>
                      <tr><th>Thời gian</th><th>Loại</th><th>Nội dung</th></tr>
                    </thead>
                    <tbody id="managerHistoryBody"> <tr><td colspan="3">Đang tải...</td></tr></tbody>
                  </table>
                  <button id="loadMoreManagerHistory" class="load-more-button" onclick="loadMoreManagerHistory()" style="display:none; margin-top: 10px;">Tải thêm</button>
                </div>
            </div>

            <!-- VIEW: IMPORT DATA -->
            <div id="view-import" class="view-section">
                <div id="excelUploadForm" class="form-section">
                  <h3 class="toggle-header active">Upload Excel Giao dịch</h3>
                  <div class="toggle-content">
                    <p class="form-hint">Nhập dữ liệu giao dịch lịch sử từ file Excel.</p>
                    <input type="file" id="excelFile" accept=".xlsx,.xls"><br>
                    <button onclick="uploadExcel()">Tải lên và xem trước</button><br>
                    <table id="excelDataTable" style="display:none;">
                      <thead> <tr>
                          <th>Ngày</th><th>Số sổ</th><th>Mã vật tư</th><th>Tên vật tư</th><th>Nhóm VT</th><th>Số lượng sử dụng</th><th>Email</th><th>Ghi chú</th>
                        </tr>
                      </thead>
                      <tbody id="excelDataBody"></tbody>
                    </table>
                    <button id="confirmExcelButton" style="display:none;" onclick="confirmExcelData()">Xác nhận và lưu</button>
                    <div id="excelSpinner" style="display:none;text-align:center;">...</div>
                    <div id="excelSuccessMessage" class="success" style="display:none;"></div>
                    <div id="excelErrorMessage" class="error" style="display:none;"></div>
                  </div>
                </div>
            </div>

            <!-- VIEW 5: SYSTEM -->
            <div id="view-system" class="view-section">
                <div id="roleManagerForm" class="form-section"> 
                  <h3 class="toggle-header active">Quản lý Phân quyền (Admin)</h3>
                  <div class="toggle-content">
                    <p class="form-hint">Chỉ Admin mới thấy mục này...</p>
                    <label for="roleUserSelect">Chọn nhân viên:</label><br>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                        <select id="roleUserSelect" style="flex: 1; margin-bottom: 0;">
                            <option value="">-- Chọn nhân viên để xem quyền --</option>
                        </select>
                    </div>

                    <!-- [MỚI] Chức năng upload ảnh đại diện -->
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                        <img id="roleAvatarPreview" src="/default-avatar.png" alt="Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
                        <div>
                            <label for="avatarUploadInput" class="btn-sm" style="background: #6c757d; cursor: pointer; display: inline-block;">
                                Chọn ảnh...
                            </label>
                            <input type="file" id="avatarUploadInput" accept="image/*" style="display: none;" onchange="handleAvatarUpload(this)">
                            <p style="font-size: 11px; color: #666; margin: 5px 0 0 0;">Chọn ảnh vuông, dưới 1MB.</p>
                        </div>
                    </div>
                    <label>Các vai trò:</label><br>
                    <div class="role-checkbox-group">
                      <label><input type="checkbox" id="roleCheckboxInventoryManager"> Quản lý Kho (Duyệt mượn)</label>
                      <label><input type="checkbox" id="roleCheckboxSale"> Phòng Kinh Doanh (Báo giá)</label>
                      <label><input type="checkbox" id="roleCheckboxAuditor"> Kiểm duyệt viên (Xem lịch sử)</label>
                    </div>
                    <button id="submitSetRolesButton" onclick="submitSetRoles()">Lưu Quyền</button>
                    <button id="cleanupButton" onclick="runCleanup()" style="background-color: var(--error-color); margin-top: 15px;">Dọn dẹp Dữ liệu Lỗi (Sổ 3 liên)</button>
                    <div id="roleManagerSpinner" style="display:none;text-align:center;"><div class="spinner"></div></div>
                    <div id="roleManagerSuccessMessage" class="success" style="display:none;"></div>
                    <div id="roleManagerErrorMessage" class="error" style="display:none;"></div>
                  </div>
                </div>
            </div>

        </div> <!-- End Content Body -->
    </main>
</div>

<!-- QR Scanner Overlay -->
<div id="qr-scanner-overlay" style="display:none;">
    <div id="qr-reader-container">
      <div id="qr-reader-header">Quét Mã Vật Tư</div>
      <div id="qr-reader"></div>
      <div id="qr-scan-error" class="error" style="display:none; margin: 10px;"></div>
      <button id="qr-reader-close-btn" onclick="stopQrScanner()">Hủy Bỏ</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<script src="common.js"></script> 
<script src="manager.js"></script> 
</body>
</html>
