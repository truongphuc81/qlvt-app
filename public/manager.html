<!DOCTYPE html>
<html>
<head>
  <title>Trang Qu·∫£n L√Ω V·∫≠t T∆∞</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <link rel="stylesheet" href="styles.css?v=2">
  <link rel="icon" href="/logo.png" type="image/png">
  <link rel="apple-touch-icon" href="/logo.png">

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <script>
    // Copy c·∫•u h√¨nh Firebase Config t·ª´ index.html
    const firebaseConfig = {
        apiKey: "AIzaSyAYiUIRQE1l-snjrZM7TJdp8YE7X8MMpEw",
        authDomain: "quan-ly-vat-tu-backend.firebaseapp.com",
        projectId: "quan-ly-vat-tu-backend",
        storageBucket: "quan-ly-vat-tu-backend.firebasestorage.app",
        messagingSenderId: "323292129107",
        appId: "1:323292129107:web:8e467d10c217197b9b63a6",
        measurementId: "G-N3VLYSXTR8"
    };
    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const auth = firebaseApp.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    const db = firebase.firestore(); // Kh·ªüi t·∫°o DB cho manager.js
  </script>
</head>
<body>
  <div class="main-header">
    <div class="brand-row">
        <div class="brand-left">
            <img src="logo.png" alt="Logo" class="header-logo">
            <h3 class="header-title">Trang Qu·∫£n L√Ω</h3>
        </div>
        <div class="brand-right">
             <button id="authButton" class="btn-login" style="display:none;">ƒêƒÉng nh·∫≠p</button>
             <button id="signOutButton" class="btn-logout" style="display:none;" onclick="firebase.auth().signOut().then(() => { window.location.href = 'index.html'; })">
                ƒêƒÉng xu·∫•t
             </button>
        </div>
    </div>

    <div class="nav-grid">
        <a href="index.html" class="nav-item-link">
            <button class="nav-btn" style="background-color: var(--secondary-color) !important;">
                < Quay l·∫°i Trang KTV
            </button>
        </a>
        <a href="auditor.html" class="nav-item-link">
            <button class="nav-btn btn-auditor">
                Xem L·ªãch s·ª≠ Kho
            </button>
        </a>
    </div>

    <button id="darkModeToggle" onclick="toggleDarkMode()" style="display:none;"></button> 
  </div>

  <div id="managerPage" class="form-section" style="display:none; margin-top: 20px;">
    
    <div id="globalOverviewSection" class="form-section toggle-section" style="display: none;">
      <h3 class="toggle-header">T·ªïng quan To√†n h·ªá th·ªëng (Admin)</h3>
      <div class="toggle-content" style="display: none;">
        <p class="form-hint">T·ªïng h·ª£p s·ªë l∆∞·ª£ng m∆∞·ª£n/tr·∫£/s·ª≠ d·ª•ng c·ªßa T·∫§T C·∫¢ k·ªπ thu·∫≠t vi√™n.</p>
        <table id="globalOverviewTable">
          <thead> 
            <tr>
              <th>T√™n v·∫≠t t∆∞</th>
              <th>M√£ v·∫≠t t∆∞</th>
              <th>T·ªïng m∆∞·ª£n</th>
              <th>T·ªïng s·ª≠ d·ª•ng</th>
              <th>T·ªïng tr·∫£</th>
              <th>T·ªïng c√≤n n·ª£ (To√†n kho)</th>
              <th>KTV ƒëang n·ª£</th>
            </tr>
          </thead>
          <tbody id="globalOverviewBody">
            <tr><td colspan="7">Nh·∫•n ƒë·ªÉ m·ªü v√† t·∫£i...</td></tr>
          </tbody>
        </table>
        <div id="globalOverviewSpinner" style="display:none; text-align:center; margin-top: 15px;">
          <div class="spinner"></div>
          <p>ƒêang t·ªïng h·ª£p d·ªØ li·ªáu to√†n h·ªá th·ªëng, vui l√≤ng ch·ªù...</p>
        </div>
      </div>
    </div>

    <div id="managerNotificationArea" class="form-section" style="display: none; background-color: #fff3cd; border-color: #ffeeba;">
      <h4><span style="color: #856404;">üîî Th√¥ng b√°o y√™u c·∫ßu ƒëang ch·ªù:</span></h4>
      <p id="pendingCountsText" style="color: #856404; font-weight: bold;"></p>
      <div id="notificationSpinner" style="display:none;"><div class="spinner"></div></div>
    </div>

    <div class="form-section">
      <h3>Ch·ªçn k·ªπ thu·∫≠t vi√™n</h3>
      <select id="technicianEmail" onchange="loadTechnicianData()">
        <option value="">Ch·ªçn k·ªπ thu·∫≠t vi√™n</option>
      </select>
      <div id="technicianSpinner" style="display:none;text-align:center;">...</div>
      <div id="technicianSuccessMessage" class="success" style="display:none;"></div>
      <div id="technicianErrorMessage" class="error" style="display:none;"></div>
    </div>

    <div id="managerBorrowForm" class="form-section toggle-section">
  <h3 class="toggle-header">Giao d·ªãch M∆∞·ª£n / Tr·∫£</h3>
  <div class="toggle-content" style="display: none;">
    
    <div class="borrow-layout">
      <div class="left-panel">
        <div class="mode-tabs">
          <div id="tab-borrow" class="mode-tab active" onclick="selectMode('borrow')">NH·∫¨P M∆Ø·ª¢N</div>
          <div id="tab-return" class="mode-tab" onclick="selectMode('return')">NH·∫¨P TR·∫¢</div>
        </div>
        
        <input type="radio" name="managerMode" id="borrowMode" checked style="display:none">
        <input type="radio" name="managerMode" id="returnUnusedMode" style="display:none">

        <div id="borrowLeftControls">
          <div class="control-group">
              <label class="toggle-switch-label" style="font-weight: bold; display: flex; align-items: center; gap: 10px;">
                  <input type="checkbox" id="directBorrow" onchange="toggleBorrowInput()"> 
                  <span>Nh·∫≠p tr·ª±c ti·∫øp (Kh√¥ng c·∫ßn l·ªánh t·ª´ KTV)</span>
              </label>
          </div>
    
              <div id="borrowNoteSelectDiv" class="control-group" style="background-color: #fff3cd; border: 1px dashed #ffeeba;">
                  <label style="color: #856404; font-weight: bold;">Ch·ªçn l·ªánh m∆∞·ª£n t·ª´ KTV:</label>
                  <select id="borrowNoteSelect" onchange="displaySelectedNote()" style="width: 100%; margin-bottom: 10px; padding: 8px;">
                      <option value="">-- Ch·ªçn l·ªánh m∆∞·ª£n --</option>
                  </select>
                  
                  <label style="font-size: 0.9em; color: #666;">Ghi ch√∫ c·ªßa KTV:</label>
                  <textarea id="technicianNote" readonly rows="2" style="width: 100%; font-size: 13px; background: #fff; border: 1px solid #ddd;"></textarea>
              </div>
    
              <div id="directBorrowNoteDiv" class="control-group" style="display:none;">
                  <label>Ghi ch√∫ m∆∞·ª£n tr·ª±c ti·∫øp:</label>
                  <textarea id="managerBorrowNote" rows="2" style="width: 100%;" placeholder="VD: Xu·∫•t cho NHCS"></textarea>
              </div>
          </div>

        <div id="returnLeftControls" style="display:none;">
            <div class="control-group">
                 <label>Ch·ªçn l·ªánh tr·∫£ (N·∫øu c√≥):</label>
                 <select id="returnNoteSelect" onchange="displaySelectedReturnNote()" style="width: 100%; margin-bottom: 10px;">
                    <option value="">-- Tr·∫£ tr·ª±c ti·∫øp --</option>
                 </select>
                 
                 <label style="font-size: 0.9em; color: #666;">Ghi ch√∫ tr·∫£ c·ªßa KTV:</label>
                 <textarea id="technicianReturnNote" readonly rows="3" style="font-size: 13px; background: #f8f9fa; border: 1px solid #eee;"></textarea>
            </div>
        </div>
      </div>

      <div class="right-panel">
        
        <div id="borrowRightPanel">
            <div class="control-group" style="padding: 10px;">
                <div class="input-row">
                    <input type="text" id="managerItemSearch" placeholder="Nh·∫≠p m√£ ho·∫∑c t√™n v·∫≠t t∆∞..." style="flex-grow: 2;">
                    <button class="btn-icon" onclick="startQrScanner()" title="Qu√©t m√£ QR" style="width: auto;">QU√âT QR</button>
                </div>
                <div class="input-row" style="margin-top: 10px;">
                    <input type="number" id="managerItemQuantity" placeholder="S·ªë l∆∞·ª£ng" min="1" style="flex-grow: 1;">
                    <button onclick="addManagerItem()" class="btn-add" title="Th√™m v√†o danh s√°ch" style="flex-grow: 0; min-width: 80px; background-color: var(--primary-color) !important;">Th√™m</button>
                </div>
            </div>
            <div id="managerBorrowSuccessMessage" class="success" style="display:none; margin-top:10px;"></div>
            <div id="managerBorrowErrorMessage" class="error" style="display:none; margin-top:10px;"></div>
            <div class="table-scroll-container">
                <table id="managerSelectedItemsTable">
                    <thead><tr><th>M√£</th><th>T√™n</th><th style="width: 60px; text-align: center;">SL</th><th style="width: 50px;">X√≥a</th></tr></thead>
                    <tbody id="managerSelectedItemsBody"></tbody>
                </table>
            </div>

            <div class="action-footer">
                <div style="flex-grow: 1; margin-right: 10px;">
                    <input type="text" id="managerTransactionDate" placeholder="Ng√†y (ƒë·ªÉ tr·ªëng = h√¥m nay)" style="display:none;">
                    <textarea id="borrowRejectionReason" placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi..." style="height: 40px; width: 100%; display:none; margin-bottom: 0; font-size: 13px;"></textarea>
                </div>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <button onclick="submitManagerBorrow()" style="margin: 0; height: 40px;">Duy·ªát & G·ª≠i</button>
                    <button onclick="toggleRejectInput('borrow')" style="margin: 0; background-color: var(--error-color) !important; font-size: 12px; padding: 5px;">T·ª´ ch·ªëi</button>
                </div>
            </div>
            
            <div id="managerBorrowSpinner" style="display:none;text-align:center; margin-top:10px;">...</div>
            
        </div>

        <div id="returnRightPanel" style="display:none;">
     
     <div class="table-scroll-container" style="max-height: 250px;">
        <table id="unusedItemsTable">
          <thead>
            <tr>
              <th>T√™n VT</th>
              <th>M√£ VT</th>
              <th style="text-align: center;">N·ª£</th>
              <th style="width: 100px;">SL Tr·∫£</th> 
              </tr>
          </thead>
          <tbody id="unusedItemsBody"><tr><td colspan="4">Vui l√≤ng ch·ªçn K·ªπ thu·∫≠t vi√™n</td></tr></tbody>
        </table>
     </div>

     <button onclick="addSelectedItemsToReturnList()" 
             style="width: 100%; margin-top: 5px; margin-bottom: 15px; background-color: var(--primary-color); height: 45px;">
        ‚Üì Th√™m c√°c m·ª•c ƒë√£ nh·∫≠p v√†o danh s√°ch
     </button>
     <div id="directReturnControls" style="margin-top: 15px; border-top: 2px dashed #eee; padding-top: 15px;">
        <h4 style="font-size: 14px; margin: 0 0 10px 0; color: var(--success-color);">Danh s√°ch x√°c nh·∫≠n tr·∫£:</h4>
                <div class="table-scroll-container" style="max-height: 150px;">
                    <table id="managerReturnListTable">
                        <thead><tr><th>T√™n</th><th>M√£</th><th>SL Tr·∫£</th><th>X√≥a</th></tr></thead>
                        <tbody id="managerReturnListBody"><tr><td colspan="4">Ch∆∞a c√≥ v·∫≠t t∆∞ n√†o.</td></tr></tbody>
                    </table>
                </div>
                
                <div class="action-footer">
                     <div style="flex-grow: 1; margin-right: 10px;">
                        <textarea id="returnRejectionReason" placeholder="L√Ω do t·ª´ ch·ªëi..." style="height: 40px; width: 100%; display:none; margin-bottom: 5px; font-size: 13px;"></textarea>
                        <textarea id="managerReturnNote" placeholder="Ghi ch√∫ tr·∫£ h√†ng (T√πy ch·ªçn)..." style="height: 40px; width: 100%; font-size: 13px; margin-bottom: 5px;"></textarea>

                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="directReturnDate" placeholder="Ng√†y tr·∫£ (DD/MM/YYYY)" style="flex: 1; margin-bottom: 0; height: 35px;" autocomplete="off">
                            <input type="text" id="approveReturnDate" style="display:none;"> 
                        </div>
                     </div>
                     <div id="returnActionButtons" style="display: flex; flex-direction: column; gap: 5px;">
                        <button onclick="handleReturnSubmit()" style="margin: 0; height: 40px;">X√°c nh·∫≠n</button>
                        <button onclick="toggleRejectInput('return')" style="margin: 0; background-color: var(--error-color) !important; font-size: 12px; padding: 5px;">T·ª´ ch·ªëi</button>
                     </div>
                </div>
             </div>
             
             <div id="returnUnusedSpinner" style="display:none;text-align:center; margin-top:10px;">...</div>
             <div id="returnUnusedSuccessMessage" class="success" style="display:none; margin-top:10px;"></div>
             <div id="returnUnusedErrorMessage" class="error" style="display:none; margin-top:10px;"></div>
        </div>

      </div> </div> </div>
</div>

    <div id="managerOverviewSection" class="form-section toggle-section">
      <h3 class="toggle-header">T·ªïng quan m·∫∑t h√†ng (KTV ƒë√£ ch·ªçn)</h3>
      <div class="toggle-content" style="display: none;">
        <table id="managerOverviewTable">
          <thead> 
            <tr>
              <th>T√™n v·∫≠t t∆∞</th><th>M√£ v·∫≠t t∆∞</th><th>T·ªïng m∆∞·ª£n</th><th>T·ªïng s·ª≠ d·ª•ng</th><th>ƒê√£ tr·∫£</th> <th>C√≤n l·∫°i</th> <th>Chi ti·∫øt s·ªë s·ªï</th><th>H√†ng ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="managerOverviewBody"></tbody>
        </table>
        <button id="fix-all-negative-btn" 
          onclick="fixAllNegativeItems()" 
          style="background-color: var(--error-color); display:none; margin-top: 15px; width: 100%; max-width: 500px;">S·ª≠a T·∫•t C·∫£ V·∫≠t T∆∞ B·ªã √Çm (V·ªÅ 0)</button>
        <div id="managerOverviewSpinner" style="display:none;text-align:center;">...</div>
      </div>
    </div>

    <div id="ticketRangeForm" class="form-section toggle-section">
      <h3 class="toggle-header">Qu·∫£n l√Ω d·∫£i s·ªë s·ªï (KTV ƒë√£ ch·ªçn)</h3>
      <div class="toggle-content" style="display: none;">
        <label>S·ªë b·∫Øt ƒë·∫ßu:</label><br>
        <input type="number" id="ticketRangeStart" class="ticket-range-input" min="1" placeholder="VD: 1"><br>
        <label>S·ªë k·∫øt th√∫c:</label><br>
        <input type="number" id="ticketRangeEnd" class="ticket-range-input" min="1" placeholder="VD: 100"><br>
        <button onclick="addTicketRange()">Th√™m d·∫£i s·ªë</button><br>
        <h4>Danh s√°ch d·∫£i s·ªë s·ªï</h4>
        <table id="ticketRangesTable">
          <thead>
            <tr><th>S·ªë b·∫Øt ƒë·∫ßu</th><th>S·ªë k·∫øt th√∫c</th><th>X√≥a</th></tr>
          </thead>
          <tbody id="ticketRangesBody"></tbody>
        </table>
        <button onclick="saveTicketRanges()">L∆∞u d·∫£i s·ªë s·ªï</button>
        <div id="ticketRangeSpinner" style="display:none;text-align:center;">...</div>
        <div id="ticketRangeSuccessMessage" class="success" style="display:none;"></div>
        <div id="ticketRangeErrorMessage" class="error" style="display:none;"></div>
      </div>
    </div>

    <div id="excelUploadForm" class="form-section toggle-section">
      <h3 class="toggle-header">Upload Excel (To√†n h·ªá th·ªëng)</h3>
      <div class="toggle-content" style="display: none;">
        <input type="file" id="excelFile" accept=".xlsx,.xls"><br>
        <button onclick="uploadExcel()">T·∫£i l√™n v√† xem tr∆∞·ªõc</button><br>
        <table id="excelDataTable" style="display:none;">
          <thead> <tr>
              <th>Ng√†y</th><th>S·ªë s·ªï</th><th>M√£ v·∫≠t t∆∞</th><th>T√™n v·∫≠t t∆∞</th><th>S·ªë l∆∞·ª£ng s·ª≠ d·ª•ng</th><th>Email</th><th>Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="excelDataBody"></tbody>
        </table>
        <button id="confirmExcelButton" style="display:none;" onclick="confirmExcelData()">X√°c nh·∫≠n v√† l∆∞u</button>
        <div id="excelSpinner" style="display:none;text-align:center;">...</div>
        <div id="excelSuccessMessage" class="success" style="display:none;"></div>
        <div id="excelErrorMessage" class="error" style="display:none;"></div>
      </div>
    </div>
    
    <div id="transferForm" class="form-section toggle-section">
      <h3 class="toggle-header">Chuy·ªÉn v·∫≠t t∆∞ (To√†n h·ªá th·ªëng)</h3>
      <div class="toggle-content" style="display: none;">
        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
          <div style="flex: 1; min-width: 250px;">
            <label for="transferFromTech">T·ª´ K·ªπ thu·∫≠t vi√™n:</label><br>
            <select id="transferFromTech" onchange="loadTransferableItems()"><option value="">-- Ch·ªçn ng∆∞·ªùi chuy·ªÉn --</option></select>
          </div>
          <div style="flex: 1; min-width: 250px;">
            <label for="transferToTech">ƒê·∫øn K·ªπ thu·∫≠t vi√™n:</label><br>
            <select id="transferToTech"><option value="">-- Ch·ªçn ng∆∞·ªùi nh·∫≠n --</option></select>
          </div>
        </div>
        <h4>V·∫≠t t∆∞ c√≥ th·ªÉ chuy·ªÉn (c·ªßa ng∆∞·ªùi chuy·ªÉn)</h4>
        <table id="transferItemsTable">
          <thead>
            <tr><th>T√™n v·∫≠t t∆∞</th><th>M√£ v·∫≠t t∆∞</th><th>ƒêang n·ª£</th><th>S·ªë l∆∞·ª£ng chuy·ªÉn</th></tr>
          </thead>
          <tbody id="transferItemsBody"><tr><td colspan="4">Vui l√≤ng ch·ªçn K·ªπ thu·∫≠t vi√™n chuy·ªÉn</td></tr></tbody>
        </table>
        <label for="transferDate">Ng√†y chuy·ªÉn:</label><br>
        <input type="text" id="transferDate" placeholder="DD/MM/YYYY" required><br> 
        <button id="submitTransferButton" onclick="submitTransfer()">X√°c nh·∫≠n chuy·ªÉn</button>
        <div id="transferSpinner" style="display:none; text-align:center;">...</div>
        <div id="transferSuccessMessage" class="success" style="display:none;"></div>
        <div id="transferErrorMessage" class="error" style="display:none;"></div>
      </div>
    </div>

    <div id="roleManagerForm" class="form-section toggle-section" style="display: none;"> 
      <h3 class="toggle-header">Qu·∫£n l√Ω Ph√¢n quy·ªÅn (Admin)</h3>
      <div class="toggle-content" style="display: none;">
        <p class="form-hint">Ch·ªâ Admin m·ªõi th·∫•y m·ª•c n√†y...</p>
        <label for="roleEmailInput">Email Ng∆∞·ªùi d√πng:</label><br>
        
        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
            <input type="email" id="roleEmailInput" placeholder="user@example.com" style="flex: 1; margin-bottom: 0;">
            <button onclick="loadUserRolesForAdmin()" class="btn-sm" style="width: auto; background: var(--secondary-color); white-space: nowrap;">
                üîç Ki·ªÉm tra
            </button>
        </div>
        <label>C√°c vai tr√≤:</label><br>
        <div class="role-checkbox-group">
          <label><input type="checkbox" id="roleCheckboxInventoryManager"> Qu·∫£n l√Ω Kho (Duy·ªát m∆∞·ª£n)</label>
          <label><input type="checkbox" id="roleCheckboxSale"> Ph√≤ng Kinh Doanh (B√°o gi√°)</label>
          <label><input type="checkbox" id="roleCheckboxAuditor"> Ki·ªÉm duy·ªát vi√™n (Xem l·ªãch s·ª≠)</label>
        </div>
        <button id="submitSetRolesButton" onclick="submitSetRoles()">L∆∞u Quy·ªÅn</button>
        <div id="roleManagerSpinner" style="display:none;text-align:center;"><div class="spinner"></div></div>
        <div id="roleManagerSuccessMessage" class="success" style="display:none;"></div>
        <div id="roleManagerErrorMessage" class="error" style="display:none;"></div>
      </div>
    </div>

    <div id="managerHistorySection" class="form-section"> 
      <h3>L·ªãch s·ª≠ Giao d·ªãch (Th·ªùi gian th·ª±c)</h3>
      <label for="managerHistoryFilterType">L·ªçc theo lo·∫°i:</label> <select id="managerHistoryFilterType" onchange="listenForManagerHistory()"> <option value="T·∫•t c·∫£">T·∫•t c·∫£</option><option value="M∆∞·ª£n">M∆∞·ª£n</option><option value="Tr·∫£">Tr·∫£</option></select>
      <label for="managerHistoryFilterTech">L·ªçc theo K·ªπ thu·∫≠t vi√™n:</label> <select id="managerHistoryFilterTech" onchange="listenForManagerHistory()"> <option value="T·∫•t c·∫£">T·∫•t c·∫£ KTV</option></select>
      <div id="managerHistorySpinner" style="display:none; text-align:center;"> ... </div>
      <table id="managerHistoryTable"> 
        <thead>
          <tr><th>Th·ªùi gian</th><th>Lo·∫°i</th><th>N·ªôi dung</th></tr>
        </thead>
        <tbody id="managerHistoryBody"> <tr><td colspan="3">ƒêang t·∫£i...</td></tr></tbody>
      </table>
      <button id="loadMoreManagerHistory" class="load-more-button" onclick="loadMoreManagerHistory()" style="display:none; margin-top: 10px;">T·∫£i th√™m</button>
    </div>
    
  </div> 
  <div id="qr-scanner-overlay" style="display:none;">
    <div id="qr-reader-container">
      <div id="qr-reader-header">Qu√©t M√£ V·∫≠t T∆∞</div>
      <div id="qr-reader"></div>
      <div id="qr-scan-error" class="error" style="display:none; margin: 10px;"></div>
      <button id="qr-reader-close-btn" onclick="stopQrScanner()">H·ªßy B·ªè</button>
    </div>
  </div> 

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script src="common.js"></script> <script src="manager.js"></script> </body>
</html>