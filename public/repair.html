<!DOCTYPE html>
<html>
<head>
  <title>Qu·∫£n L√Ω S·ª≠a Ch·ªØa</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <link rel="stylesheet" href="styles.css?v=2">
  <link rel="icon" href="/logo.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script> <script>
    // Copy c·∫•u h√¨nh Firebase Config t·ª´ index.html
    const firebaseConfig = {
        apiKey: "AIzaSyAYiUIRQE1l-snjrZM7TJdp8YE7X8MMpEw",
        authDomain: "quan-ly-vat-tu-backend.firebaseapp.com",
        projectId: "quan-ly-vat-tu-backend",
        storageBucket: "quan-ly-vat-tu-backend.firebasestorage.app", 
        messagingSenderId: "323292129107",
        appId: "1:323292129107:web:8e467d10c217197b9b63a6",
        measurementId: "G-N3VLYSXTR8"
    };
    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const auth = firebaseApp.auth();
    const db = firebase.firestore();
    const storage = firebase.storage(); // Kh·ªüi t·∫°o Storage
  </script>
</head>
<body>
  <div class="main-header">
    <div class="brand-row">
        <div class="brand-left">
            <img src="logo.png" alt="Logo" class="header-logo">
            <h3 class="header-title">D·ªãch V·ª• S·ª≠a Ch·ªØa</h3>
        </div>
        <div class="brand-right">
             <button id="authButton" class="btn-login" style="display:none;">ƒêƒÉng nh·∫≠p</button>
             <button id="signOutButton" class="btn-logout" style="display:none;" onclick="firebase.auth().signOut().then(() => { window.location.href = 'index.html'; })">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>
    <div class="nav-grid">
        <a href="index.html" class="nav-item-link">
            <button class="nav-btn" style="background-color: var(--secondary-color) !important;">&lt; Trang Ch·ªß</button>
        </a>
        <button id="btnShowList" class="nav-btn btn-manager" onclick="showView('list')" style="display:none;">Danh S√°ch Phi·∫øu</button>
        <button id="btnShowCreate" class="nav-btn btn-add" onclick="showView('create')">+ T·∫°o Phi·∫øu M·ªõi</button>
    </div>
  </div>

  <div id="app-container" style="display:none;"> <div id="listView" class="form-section">
        <div class="filter-bar">
            <div style="display:flex; flex:2; gap:5px;">
                <input type="text" id="searchTicket" placeholder="üîç T√¨m M√£ phi·∫øu / SƒêT..." style="width:100%; height:45px;">
                <button onclick="startTicketQrScanner()" class="btn-icon" style="width:50px; justify-content:center; height:45px; background:#6c757d;" title="Qu√©t m√£ phi·∫øu">
                    üì∑
                </button>
            </div>
            
            <select id="filterStatus" style="flex: 1; height:45px;">
                <option value="" selected>-- T·∫•t c·∫£ tr·∫°ng th√°i --</option>
                <option value="Ch∆∞a ho√†n t·∫•t">Ch∆∞a ho√†n t·∫•t (ƒêang x·ª≠ l√Ω)</option>
                <option value="Ho√†n t·∫•t">ƒê√£ ho√†n t·∫•t</option>
            </select>
            <button onclick="loadTickets()" style="width: auto; height:45px;">L·ªçc</button>
        </div>

        <div id="ticketQrModal" class="modal-overlay" style="display:none;">
            <div class="modal-content" style="text-align:center;">
                <h3>Qu√©t M√£ Phi·∫øu</h3>
                <div id="ticket-qr-reader" style="width:100%;"></div>
                <button onclick="stopTicketQrScanner()" style="margin-top:15px; background:#ccc; color:#333;">ƒê√≥ng Camera</button>
            </div>
        </div>
        <div class="table-scroll-container">
            <table id="ticketTable">
                <thead>
                    <tr>
                        <th>M√£ Phi·∫øu</th>
                        <th>Kh√°ch H√†ng</th>
                        <th>Thi·∫øt B·ªã</th>
                        <th>Tr·∫°ng Th√°i</th>
                        <th>Ng√†y Nh·∫≠n</th>
                        <th>Chi Ti·∫øt</th>
                    </tr>
                </thead>
                <tbody id="ticketTableBody">
                    <tr><td colspan="6" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
        <button id="loadMoreTickets" class="load-more-button" onclick="loadMoreTickets()">T·∫£i th√™m</button>
    </div>

    <div id="createView" class="form-section" style="display:none;">
        <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px;">T·∫°o Phi·∫øu Ti·∫øp Nh·∫≠n M·ªõi</h3>
        
        <div class="borrow-layout">
            <div class="left-panel">
                <h4>1. Th√¥ng Tin Kh√°ch H√†ng</h4>
                <div class="control-group">
                    <label>T√™n kh√°ch h√†ng (*):</label>
                    <input type="text" id="custName" placeholder="VD: Nguy·ªÖn VƒÉn A">
                    
                    <label>S·ªë ƒëi·ªán tho·∫°i (*):</label>
                    <input type="tel" id="custPhone" placeholder="VD: 0912345678">
                    
                    <label>ƒê·ªãa ch·ªâ:</label>
                    <input type="text" id="custAddress" placeholder="ƒê·ªãa ch·ªâ (T√πy ch·ªçn)">
                </div>

                <h4>2. Th√¥ng Tin Thi·∫øt B·ªã</h4>
                <div class="control-group">
                    <label>Lo·∫°i thi·∫øt b·ªã:</label>
                    <select id="deviceType">
                        <option value="Laptop">Laptop</option>
                        <option value="PC">PC / M√°y b√†n</option>
                        <option value="Printer">M√°y in</option>
                        <option value="Phone">ƒêi·ªán tho·∫°i</option>
                        <option value="Other">Kh√°c</option>
                    </select>

                    <div class="input-row">
                        <div style="flex:1"><label>H√£ng:</label><input type="text" id="deviceBrand" placeholder="Dell, HP..."></div>
                        <div style="flex:1"><label>Model:</label><input type="text" id="deviceModel" placeholder="XPS 13..."></div>
                    </div>
                    
                    <label>Serial / IMEI / Service Tag:</label>
                    <input type="text" id="deviceSerial" placeholder="Nh·∫≠p s·ªë serial...">

                    <label>Ph·ª• ki·ªán ƒëi k√®m:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" class="acc-check" value="S·∫°c"> S·∫°c</label>
                        <label><input type="checkbox" class="acc-check" value="Chu·ªôt"> Chu·ªôt</label>
                        <label><input type="checkbox" class="acc-check" value="T√∫i"> T√∫i</label>
                        <label><input type="checkbox" class="acc-check" value="H·ªôp m·ª±c"> H·ªôp m·ª±c</label>
                    </div>
                    <input type="text" id="deviceAccessories" placeholder="Ghi ch√∫ ph·ª• ki·ªán kh√°c...">
                </div>
            </div>

            <div class="right-panel">
                <h4>3. T√¨nh Tr·∫°ng Khi Nh·∫≠n</h4>
                <div class="control-group">
                    <label>L·ªói kh√°ch m√¥ t·∫£ (*):</label>
                    <textarea id="customerDesc" rows="3" placeholder="VD: M√°y kh√¥ng l√™n ngu·ªìn, m√†n h√¨nh ch·ªõp..."></textarea>
                    
                    <label>Ngo·∫°i h√¨nh ghi nh·∫≠n:</label>
                    <textarea id="physicalDesc" rows="2" placeholder="VD: Tr·∫ßy g√≥c tr√°i, m√≥p n·∫Øp l∆∞ng..."></textarea>
                </div>

                <h4>4. H√¨nh ·∫¢nh (T·ªëi ƒëa 5 ·∫£nh)</h4>
                <div class="control-group">
                    <input type="file" id="photoInput_Cam" accept="image/*" capture="environment" style="display:none;" onchange="handlePhotoSelect(this)">
                    <input type="file" id="photoInput_Gal" accept="image/*" multiple style="display:none;" onchange="handlePhotoSelect(this)">
                    
                    <button onclick="openPhotoActionSheet('photoInput')" class="btn-icon" style="width:100%; justify-content:center; height:45px;">
                        üì∑ Th√™m h√¨nh ·∫£nh
                    </button>
                    
                    <div id="photoPreviewGrid" class="photo-grid"></div>
                </div>

                <h4>5. Th√¥ng Tin Nh·∫≠n</h4>
                <div class="control-group">
                    <label>Ghi ch√∫ n·ªôi b·ªô:</label>
                    <textarea id="internalNote" rows="2" placeholder="Ghi ch√∫ cho k·ªπ thu·∫≠t..."></textarea>
                </div>

                <div class="action-footer">
                    <button onclick="showView('list')" style="background-color: var(--secondary-color) !important;">H·ªßy</button>
                    <button onclick="submitTicket(false)" style="background-color: var(--primary-color);">L∆∞u Phi·∫øu</button>
                    <button onclick="submitTicket(true)" style="background-color: #28a745 !important;">L∆∞u & In</button>
                </div>
                <div id="createSpinner" style="display:none;text-align:center; margin-top:10px;">
                    <div class="spinner"></div> ƒêang x·ª≠ l√Ω (N√©n ·∫£nh & L∆∞u)...
                </div>
            </div>
        </div>
    </div>
    <div id="detailView" class="form-section" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:20px;">
        <div style="display:flex; align-items:center; gap:15px;">
            <button onclick="showView('list')" style="background:#f1f3f4; color:#333; border:none; padding:8px 15px; border-radius:20px; font-weight:600;">‚Üê Quay l·∫°i</button>
            <div>
                <h3 style="margin:0; color:var(--primary-color);">Phi·∫øu: <span id="d_ticketId">...</span></h3>
                <span id="d_createdAt" style="font-size:13px; color:#666;">...</span>
            </div>
        </div>
        <div style="display:flex; gap: 10px;">
            <button class="btn-icon" onclick="printTicket()" style="background:#6c757d; padding: 8px 15px;">
                üñ®Ô∏è In Bi√™n Nh·∫≠n
            </button>

            <button class="btn-icon" onclick="printDeviceLabel()" style="background:#ffc107; color:#000; padding: 8px 15px;">
                üè∑Ô∏è In Tem D√°n
            </button>
        </div>
    </div>

    <div class="timeline-wrapper" style="margin-bottom:30px; overflow-x:auto; padding-bottom:10px;">
        <div class="timeline-steps">
            <div class="step active" id="step_new">
                <div class="step-circle">1</div>
                <div class="step-label">Ti·∫øp nh·∫≠n</div>
            </div>
            <div class="step" id="step_check">
                <div class="step-circle">2</div>
                <div class="step-label">Ki·ªÉm tra</div>
            </div>
            <div class="step" id="step_quote">
                <div class="step-circle">3</div>
                <div class="step-label">B√°o gi√°</div>
            </div>
            <div class="step" id="step_repair">
                <div class="step-circle">4</div>
                <div class="step-label">S·ª≠a ch·ªØa</div>
            </div>
            <div class="step" id="step_done">
                <div class="step-circle">5</div>
                <div class="step-label">Ho√†n t·∫•t</div>
            </div>
        </div>
    </div>

    <div class="borrow-layout">
        <div class="left-panel">
            
            <div class="control-group">
                <h4>üë§ Kh√°ch h√†ng</h4>
                <div style="margin-bottom:5px;"><strong>T√™n:</strong> <span id="d_custName">...</span></div>
                <div style="margin-bottom:5px;"><strong>SƒêT:</strong> <span id="d_custPhone" style="color:blue;">...</span></div>
                <div style="margin-bottom:5px;"><strong>ƒê/C:</strong> <span id="d_custAddress">...</span></div>
            </div>

            <div class="control-group">
                <h4>üíª Thi·∫øt b·ªã ti·∫øp nh·∫≠n</h4>
                <div style="margin-bottom:5px;"><strong>M√°y:</strong> <span id="d_deviceInfo">...</span></div>
                <div style="margin-bottom:5px;"><strong>Serial:</strong> <span id="d_deviceSerial">...</span></div>
                <div style="margin-bottom:5px;"><strong>Ph·ª• ki·ªán:</strong> <span id="d_accessories">...</span></div>
            </div>

            <div class="control-group">
                <h4>‚ö†Ô∏è T√¨nh tr·∫°ng ban ƒë·∫ßu</h4>
                <p><strong>Kh√°ch b√°o:</strong> <span id="d_issueDesc">...</span></p>
                <p><strong>Ngo·∫°i h√¨nh:</strong> <span id="d_physicalDesc">...</span></p>
                <div style="margin-bottom:5px; border-bottom:1px dashed #eee; padding-bottom:5px;">
                    <strong>Ng∆∞·ªùi nh·∫≠n:</strong> <span id="d_receiver">...</span>
                </div>
                <h5 style="margin-top:15px; margin-bottom:5px;">·∫¢nh ti·∫øp nh·∫≠n:</h5>
                <div id="d_receivePhotos" class="photo-grid" style="grid-template-columns: repeat(3, 1fr);"></div>
            </div>
        </div>

        <div class="right-panel">
            
            <div class="control-group" id="block_techCheck">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4>üõ†Ô∏è K·ªπ thu·∫≠t ki·ªÉm tra</h4>
                    <button id="btn_update_check" class="btn-sm" onclick="openUpdateModal('check')">C·∫≠p nh·∫≠t</button>
                </div>
                <div id="content_techCheck" style="color:#666; font-style:italic;">Ch∆∞a c√≥ d·ªØ li·ªáu ki·ªÉm tra.</div>
            </div>

            <div class="control-group" id="block_quotation" style="opacity:0.6;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0;">üí∞ B√°o gi√° s·ª≠a ch·ªØa</h4>
                    <button id="btn_update_quote" class="btn-sm" onclick="openUpdateModal('quote')" style="display:none;">C·∫≠p nh·∫≠t</button>
                </div>
                <div id="content_quotation">ƒêang ch·ªù ki·ªÉm tra...</div>
            </div>

            <div class="control-group" id="block_repair" style="opacity:0.6;">
                <h4>üîß Qu√° tr√¨nh s·ª≠a ch·ªØa</h4>
                <div id="content_repair">---</div>
            </div>

        </div>
    </div>
</div>
<div id="modalTechCheck" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>üõ†Ô∏è C·∫≠p Nh·∫≠t K·∫øt Qu·∫£ Ki·ªÉm Tra</h3>
        
        <label>Nguy√™n nh√¢n l·ªói (*):</label>
        <textarea id="check_cause" rows="3" placeholder="VD: Mainboard b·ªã ch·∫°m ngu·ªìn..."></textarea>
        
        <label>ƒê·ªÅ xu·∫•t x·ª≠ l√Ω:</label>
            <select id="check_solution">
                <option value="S·ª≠a ch·ªØa">S·ª≠a ch·ªØa / Thay th·∫ø</option>
                <option value="C√†i ƒë·∫∑t">C√†i ƒë·∫∑t ph·∫ßn m·ªÅm</option>
                
                <option value="G·ª≠i s·ª≠a ngo√†i">G·ª≠i s·ª≠a ngo√†i</option>
                <option value="G·ª≠i h√£ng">G·ª≠i b·∫£o h√†nh h√£ng</option>
                <option value="Kh√¥ng s·ª≠a ƒë∆∞·ª£c">Tr·∫£ m√°y (Kh√¥ng s·ª≠a ƒë∆∞·ª£c)</option>
            </select>
        
        <label>Linh ki·ªán c·∫ßn thay (n·∫øu c√≥):</label>
        <textarea id="check_components" rows="2" placeholder="VD: C·∫ßn thay m√†n h√¨nh 14 inch 30 pin..."></textarea>
        
        <label>·∫¢nh ki·ªÉm tra (n·∫øu c·∫ßn):</label>
        <div class="control-group">
            <input type="file" id="checkPhotoInput_Cam" accept="image/*" capture="environment" style="display:none;" onchange="handleCheckPhotoSelect(this)">
            <input type="file" id="checkPhotoInput_Gal" accept="image/*" multiple style="display:none;" onchange="handleCheckPhotoSelect(this)">
            
            <button onclick="openPhotoActionSheet('checkPhotoInput')" class="btn-icon" style="width:100%; justify-content:center; height:45px;">
                üì∑ Th√™m h√¨nh ·∫£nh
            </button>
            
            <div id="checkPhotoGrid" class="photo-grid"></div>
        </div>

        <div class="action-footer" style="margin-top:20px;">
            <button onclick="closeModal('modalTechCheck')" style="background:#ccc; color:#333;">H·ªßy</button>
            <button onclick="submitTechCheck()" style="background:var(--primary-color);">L∆∞u & G·ª≠i B√°o Gi√°</button>
        </div>
    </div>
</div>
        <div id="modalQuote" class="modal-overlay" style="display:none;">
            <div class="modal-content" style="max-width: 800px;"> <h3>üí∞ L√™n B√°o Gi√° Chi Ti·∫øt</h3>
                
                <div class="radio-group-container">
                    <label class="group-label">H√¨nh th·ª©c x·ª≠ l√Ω:</label>
                    <div class="radio-options">
                        <label class="radio-item">
                            <input type="radio" name="quoteType" value="INTERNAL" checked onchange="toggleQuoteType()"> 
                            S·ª≠a t·∫°i ch·ªó
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="quoteType" value="EXTERNAL" onchange="toggleQuoteType()"> 
                            G·ª≠i ƒë∆°n v·ªã ngo√†i
                        </label>
                    </div>
                </div>
                
                <div id="ext_unit_div" class="control-group ext-only" style="margin-bottom:10px; background:#fff3e0; border:1px solid #ffe0b2;">
                    <label>T√™n ƒë∆°n v·ªã s·ª≠a ch·ªØa / H√£ng:</label>
                    <input type="text" id="q_ext_unit" placeholder="VD: Trung t√¢m b·∫£o h√†nh Dell..." style="margin-bottom:0;">
                </div>

                <div id="quoteTableContainer">
                    <table style="width: 100%; font-size: 13px; margin-bottom: 10px;">
                        <thead>
                            <tr style="background: #f1f1f1;">
                                <th>T√™n linh ki·ªán / D·ªãch v·ª•</th>
                                <th style="width: 60px;">SL</th>
                                <th class="ext-only" style="width: 130px; color:#e65100;">Gi√° G·ªëc (A)</th>
                                <th style="width: 130px; color:#2e7d32;">Gi√° B√°n (B)</th>
                                <th style="width: 30px;"></th>
                            </tr>
                        </thead>
                        <tbody id="quoteItemsBody"></tbody>
                    </table>
                </div>
                
                <button onclick="addQuoteRow()" class="btn-sm" style="background: var(--secondary-color); margin-bottom: 15px;">+ Th√™m d√≤ng</button>

                <div id="ext_ship_div" class="ext-only" style="display:flex; justify-content:flex-end; align-items:center; margin-bottom:10px; gap:10px;">
                    <label style="margin:0; color:#666;">+ Ph√≠ v·∫≠n chuy·ªÉn (N·ªôi b·ªô):</label>
                    <input type="number" id="q_ext_ship" class="calc-input" placeholder="0" oninput="calculateQuoteTotal()" style="width:120px; text-align:right; margin:0;">
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size:1.1em;">T·ªïng B√°o Kh√°ch (B):</span>
                        <strong id="quote_total_display" style="font-size: 1.4em; color: #2e7d32;">0 ƒë</strong>
                    </div>
                    
                    <div id="profit_display_div" class="ext-only" style="display:flex; justify-content: space-between; align-items: center; margin-top:5px; font-size:13px; color:#666; border-top:1px dashed #ccc; padding-top:5px;">
                        <span>L·ª£i nhu·∫≠n d·ª± ki·∫øn (B - A - Ship):</span>
                        <strong id="quote_profit_display" style="color: #e65100;">0 ƒë</strong>
                    </div>
                </div>
                
                <div class="input-row">
                    <div style="flex:1">
                        <label>B·∫£o h√†nh:</label>
                        <input type="text" id="quote_warranty" placeholder="VD: 3 th√°ng...">
                    </div>
                </div>
                
                <label>Ghi ch√∫ th√™m (Option):</label>
                <textarea id="quote_notes" rows="2" placeholder="VD: Gi√° ch∆∞a bao g·ªìm VAT..."></textarea>

                <div class="action-footer" style="margin-top:20px;">
                    <button onclick="closeModal('modalQuote')" style="background:#ccc; color:#333;">H·ªßy</button>
                    <button onclick="submitQuote()" style="background:var(--primary-color);">G·ª≠i B√°o Gi√°</button>
                </div>
            </div>
        </div>

        <div id="external_cost_block" style="display:none; background: #fff3e0; padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ffe0b2;">
            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #e65100;">T√≠nh to√°n gi√° v·ªën (N·ªôi b·ªô)</h4>
            <div class="input-row">
                <div style="flex:1">
                    <label>T√™n ƒë∆°n v·ªã ngo√†i:</label>
                    <input type="text" id="q_ext_unit" placeholder="VD: H√£ng, C·ª≠a h√†ng A...">
                </div>
                <div style="flex:1">
                    <label>Gi√° h·ªç b√°o (A):</label>
                    <input type="number" id="q_ext_cost" class="calc-input" placeholder="0">
                </div>
            </div>
            <div class="input-row">
                <div style="flex:1">
                    <label>Ph√≠ v·∫≠n chuy·ªÉn (B):</label>
                    <input type="number" id="q_ext_ship" class="calc-input" placeholder="0">
                </div>
                <div style="flex:1">
                    <label>C√¥ng ty l·ªùi (C):</label>
                    <input type="number" id="q_ext_profit" class="calc-input" placeholder="0">
                </div>
            </div>
            <div style="text-align: right; font-size: 13px; color: #666;">
                Gi√° b√°o kh√°ch (A + B + C) = <strong id="q_ext_total_preview" style="color: #d32f2f; font-size: 16px;">0</strong>
            </div>
            <div style="text-align: right; margin-top: 5px;">
                <button class="btn-sm" onclick="applyExternalPriceToTable()">‚¨á √Åp d·ª•ng gi√° n√†y xu·ªëng b·∫£ng</button>
            </div>
        </div>
        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 13px;">
            <strong>ƒê·ªÅ xu·∫•t t·ª´ KTV:</strong> <span id="quote_tech_summary">...</span>
        </div>

        <table style="width: 100%; font-size: 13px; margin-bottom: 10px;">
            <thead>
                <tr style="background: #f1f1f1;">
                    <th>T√™n linh ki·ªán / D·ªãch v·ª•</th>
                    <th style="width: 100px;">SL</th>
                    <th style="width: 160px;">ƒê∆°n gi√°</th>
                    <th style="width: 40px;"></th>
                </tr>
            </thead>
            <tbody id="quoteItemsBody">
                </tbody>
        </table>
        
        <button onclick="addQuoteRow()" class="btn-sm" style="background: var(--secondary-color); margin-bottom: 15px;">+ Th√™m d√≤ng</button>

        <div style="display: flex; justify-content: space-between; align-items: center; background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            <strong>T·ªîNG C·ªòNG:</strong>
            <strong id="quote_total_display" style="font-size: 1.2em; color: #d32f2f;">0 ƒë</strong>
        </div>
        
        <div class="input-row">
            <div style="flex:1">
                <label>B·∫£o h√†nh:</label>
                <input type="text" id="quote_warranty" placeholder="VD: 3 th√°ng...">
            </div>
        </div>
        
        <label>Ghi ch√∫ th√™m (Option):</label>
        <textarea id="quote_notes" rows="2" placeholder="VD: Gi√° ch∆∞a bao g·ªìm VAT..."></textarea>

        <div class="action-footer" style="margin-top:20px;">
            <button onclick="closeModal('modalQuote')" style="background:#ccc; color:#333;">H·ªßy</button>
            <button onclick="submitQuote()" style="background:var(--primary-color);">G·ª≠i B√°o Gi√°</button>
        </div>
    </div>
</div>
<div id="modalRepair" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>‚úÖ B√°o C√°o Ho√†n T·∫•t S·ª≠a Ch·ªØa</h3>
        
        <label>C√¥ng vi·ªác ƒë√£ th·ª±c hi·ªán (*):</label>
        <textarea id="repair_work" rows="4" placeholder="VD: ƒê√£ thay IC ngu·ªìn, v·ªá sinh mainboard, test full ch·ª©c nƒÉng..."></textarea>
        
        <label>B·∫£o h√†nh (cho kh√°ch):</label>
        <input type="text" id="repair_warranty" placeholder="VD: 1 th√°ng, 3 th√°ng...">
        
        <label>·∫¢nh sau khi s·ª≠a / B√†n giao:</label>
        <div class="control-group">
            <input type="file" id="repairPhotoInput_Cam" accept="image/*" capture="environment" style="display:none;" onchange="handleRepairPhotoSelect(this)">
            <input type="file" id="repairPhotoInput_Gal" accept="image/*" multiple style="display:none;" onchange="handleRepairPhotoSelect(this)">
            
            <button onclick="openPhotoActionSheet('repairPhotoInput')" class="btn-icon" style="width:100%; justify-content:center; height:45px;">
                üì∑ Th√™m h√¨nh ·∫£nh
            </button>
            
            <div id="repairPhotoGrid" class="photo-grid"></div>
        </div>

        <div class="action-footer" style="margin-top:20px;">
            <button onclick="closeModal('modalRepair')" style="background:#ccc; color:#333;">H·ªßy</button>
            <button onclick="submitRepairComplete()" style="background:var(--success-color);">X√°c nh·∫≠n S·ª≠a Xong</button>
        </div>
    </div>
</div>
<div id="modalReturn" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>üí∏ Thanh To√°n & Tr·∫£ M√°y</h3>
        
        <div class="control-group" style="background: #e8f5e9; border: 1px solid #c8e6c9;">
            <label>T·ªïng ti·ªÅn kh√°ch ph·∫£i tr·∫£ (theo b√°o gi√°):</label>
            <div id="return_quote_price" style="font-size: 1.5em; font-weight: bold; color: #2e7d32; text-align: right;">0 ƒë</div>
        </div>

        <div class="input-row">
            <div style="flex:1">
                <label>Th·ª±c thu (VNƒê) (*):</label>
                <input type="number" id="return_amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn...">
            </div>
            <div style="flex:1">
                <label>H√¨nh th·ª©c (*):</label>
                <select id="return_method">
                    <option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
                    <option value="Chuy·ªÉn kho·∫£n">Chuy·ªÉn kho·∫£n</option>
                    <option value="C√¥ng n·ª£">C√¥ng n·ª£</option>
                    <option value="Kh√¥ng thu ti·ªÅn">Kh√¥ng thu ti·ªÅn</option> 
                    <option value="Kh√°c">Kh√°c</option>
                </select>
            </div>
        </div>
        
        <label>S·ªë s·ªï 3 li√™n (B·∫Øt bu·ªôc):</label>
        <input type="text" id="return_ticket_number" placeholder="VD: 001234">
        
        <label>Ghi ch√∫ b√†n giao:</label>
        <textarea id="return_note" rows="2" placeholder="VD: Kh√°ch ƒë√£ ki·ªÉm tra m√°y ok..."></textarea>
        
        <label>·∫¢nh b√†n giao (S·ªï 3 li√™n):</label>
        <div class="control-group">
            <input type="file" id="returnPhotoInput_Cam" accept="image/*" capture="environment" style="display:none;" onchange="handleReturnPhotoSelect(this)">
            <input type="file" id="returnPhotoInput_Gal" accept="image/*" multiple style="display:none;" onchange="handleReturnPhotoSelect(this)">
            
            <button onclick="openPhotoActionSheet('returnPhotoInput')" class="btn-icon" style="width:100%; justify-content:center; height:45px;">
                üì∑ Th√™m h√¨nh ·∫£nh
            </button>
            
            <div id="returnPhotoGrid" class="photo-grid"></div>
        </div>

        <div class="action-footer" style="margin-top:20px;">
            <button onclick="closeModal('modalReturn')" style="background:#ccc; color:#333;">H·ªßy</button>
            <button onclick="submitReturnDevice()" style="background:#28a745;">X√°c nh·∫≠n & Ho√†n t·∫•t</button>
        </div>
    </div>
</div>
<div id="imageViewerModal" class="image-modal" onclick="closeImageModal()">
  <span class="close-img">&times;</span>
  <img class="image-modal-content" id="imgExpanded">
  <div id="imgCaption"></div>
</div>
<div id="photoActionSheet" class="modal-overlay" style="display:none; align-items: flex-end;" onclick="closePhotoActionSheet()">
    <div class="action-sheet-content" onclick="event.stopPropagation()">
        <h4 style="text-align:center; margin-bottom:15px; color:#666;">B·∫°n mu·ªën ch·ªçn ·∫£nh t·ª´ ƒë√¢u?</h4>
        
        <button onclick="triggerPhotoInput('cam')" class="sheet-btn">
            üì∑ &nbsp; Ch·ª•p ·∫£nh m·ªõi
        </button>
        
        <button onclick="triggerPhotoInput('gal')" class="sheet-btn">
            üñºÔ∏è &nbsp; Ch·ªçn t·ª´ Th∆∞ vi·ªán
        </button>
        
        <button onclick="closePhotoActionSheet()" class="sheet-btn cancel">
            H·ªßy b·ªè
        </button>
    </div>
</div>
<div id="modalExtSend" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>üöö G·ª≠i M√°y ƒêi S·ª≠a Ngo√†i</h3>
        <p>X√°c nh·∫≠n g·ª≠i m√°y cho ƒë∆°n v·ªã ƒë·ªëi t√°c?</p>
        
        <label>ƒê∆°n v·ªã ti·∫øp nh·∫≠n:</label>
        <input type="text" id="ext_send_unit" placeholder="T√™n c·ª≠a h√†ng/h√£ng..." readonly style="background:#eee;">
        
        <label>Ghi ch√∫ g·ª≠i h√†ng:</label>
        <textarea id="ext_send_note" rows="2" placeholder="VD: G·ª≠i k√®m s·∫°c, pass m√°y l√†..."></textarea>

        <div class="action-footer">
            <button onclick="closeModal('modalExtSend')" style="background:#ccc; color:#333;">H·ªßy</button>
            <button onclick="submitExternalAction('SEND')" style="background:var(--primary-color);">X√°c nh·∫≠n G·ª≠i</button>
        </div>
    </div>
</div>

<div id="modalExtReceive" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>‚úÖ Nh·∫≠n M√°y & Ki·ªÉm Tra (QC)</h3>
        <p>M√°y ƒë√£ ƒë∆∞·ª£c g·ª≠i tr·∫£ v·ªÅ. K·ªπ thu·∫≠t vi√™n c·∫ßn ki·ªÉm tra l·∫°i.</p>
        
        <label>K·∫øt qu·∫£ ki·ªÉm tra (QC):</label>
        <select id="ext_qc_result">
            <option value="PASS">ƒê·∫°t - M√°y ho·∫°t ƒë·ªông t·ªët</option>
            </select>
        
        <label>Ghi ch√∫ ki·ªÉm tra:</label>
        <textarea id="ext_qc_note" rows="3" placeholder="VD: ƒê√£ test full ch·ª©c nƒÉng, tem b·∫£o h√†nh nguy√™n v·∫πn..."></textarea>

        <div class="action-footer">
            <button onclick="closeModal('modalExtReceive')" style="background:#ccc; color:#333;">H·ªßy</button>
            <button onclick="submitExternalAction('RECEIVE_PASS')" style="background:#28a745;">QC ƒê·∫°t - Ch·ªù Tr·∫£ Kh√°ch</button>
        </div>
    </div>
</div>
  </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script src="common.js"></script>
  <script src="repair.js"></script> </body>
</html>