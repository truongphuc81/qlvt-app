<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n L√Ω D·ªãch V·ª• S·ª≠a Ch·ªØa</title>
  <link rel="icon" href="/logo.png" type="image/png">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <link rel="stylesheet" href="styles2.css?v=3">

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script>
    // Config Firebase (Gi·ªØ nguy√™n)
    const firebaseConfig = {
        apiKey: "AIzaSyAYiUIRQE1l-snjrZM7TJdp8YE7X8MMpEw",
        authDomain: "quan-ly-vat-tu-backend.firebaseapp.com",
        projectId: "quan-ly-vat-tu-backend",
        storageBucket: "quan-ly-vat-tu-backend.firebasestorage.app", 
        messagingSenderId: "323292129107",
        appId: "1:323292129107:web:8e467d10c217197b9b63a6"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
  </script>
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="index.html">
            <i class="fas fa-tools me-2"></i> D·ªäCH V·ª§ S·ª¨A CH·ªÆA
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active" id="btnShowList" href="#" onclick="showView('list')"><i class="fas fa-list"></i> Danh s√°ch</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="btnShowCreate" href="#" onclick="showView('create')"><i class="fas fa-plus-circle"></i> Ti·∫øp nh·∫≠n m·ªõi</a>
                </li>
            </ul>
            <div class="d-flex align-items-center text-white">
                <span id="userDisplay" class="me-3 d-none d-md-block">Loading...</span>
                <button id="authButton" class="btn btn-light btn-sm fw-bold text-primary">ƒêƒÉng nh·∫≠p</button>
                <button id="signOutButton" class="btn btn-outline-light btn-sm" style="display:none;" onclick="firebase.auth().signOut()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </div>
  </nav>

  <div id="app-container" class="container-fluid mt-4" style="display:none;">
    
    <div id="listView">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <div class="row g-2 mb-3 align-items-center">
                    <div class="col-md-6 col-12">
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="searchTicket" class="form-control" placeholder="T√¨m M√£ phi·∫øu, SƒêT, T√™n kh√°ch...">
                            <button class="btn btn-outline-secondary" onclick="startTicketQrScanner()"><i class="fas fa-qrcode"></i></button>
                        </div>
                    </div>
                    <div class="col-md-4 col-12">
                        <select id="filterStatus" class="form-select">
                            <option value="" selected>-- T·∫•t c·∫£ tr·∫°ng th√°i --</option>
                            <option value="Ch∆∞a ho√†n t·∫•t">ƒêang x·ª≠ l√Ω (Ch∆∞a ho√†n t·∫•t)</option>
                            <option value="Ho√†n t·∫•t">ƒê√£ ho√†n t·∫•t</option>
                        </select>
                    </div>
                    <div class="col-md-2 col-12 d-grid">
                        <button class="btn btn-primary" onclick="loadTickets()">L·ªçc D·ªØ Li·ªáu</button>
                    </div>
                </div>

                <div class="table-responsive" style="min-height: 400px;">
                    <table class="table table-hover table-striped align-middle" id="ticketTable">
                        <thead class="table-light">
                            <tr>
                                <th>M√£ Phi·∫øu</th>
                                <th>Kh√°ch H√†ng</th>
                                <th>Thi·∫øt B·ªã & L·ªói</th>
                                <th>Tr·∫°ng Th√°i</th>
                                <th class="d-none d-md-table-cell">Ng√†y Nh·∫≠n</th>
                                <th class="text-center">Thao T√°c</th>
                            </tr>
                        </thead>
                        <tbody id="ticketTableBody">
                            <tr><td colspan="6" class="text-center text-muted py-4">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-grid mt-3">
                    <button id="loadMoreTickets" class="btn btn-light border" onclick="loadMoreTickets()">T·∫£i th√™m</button>
                </div>
            </div>
        </div>
    </div>

    <div id="createView" style="display:none;">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-primary"><i class="fas fa-file-alt me-2"></i> T·∫°o Phi·∫øu Ti·∫øp Nh·∫≠n</h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase fw-bold mb-3">1. Kh√°ch H√†ng & Thi·∫øt B·ªã</h6>
                        <div class="mb-3">
                            <label class="form-label">T√™n kh√°ch h√†ng <span class="text-danger">*</span></label>
                            <input type="text" id="custName" class="form-control" placeholder="VD: Nguy·ªÖn VƒÉn A">
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
                                <input type="tel" id="custPhone" class="form-control" placeholder="09xxxxxxxx">
                            </div>
                            <div class="col-6">
                                <label class="form-label">ƒê·ªãa ch·ªâ</label>
                                <input type="text" id="custAddress" class="form-control" placeholder="Qu·∫≠n/Huy·ªán...">
                            </div>
                        </div>
                        <hr class="border-secondary opacity-10">
                        <div class="row g-2 mb-3">
                            <div class="col-4">
                                <label class="form-label">Lo·∫°i m√°y</label>
                                <select id="deviceType" class="form-select">
                                    <option value="Laptop">Laptop</option>
                                    <option value="PC">PC/M√°y b√†n</option>
                                    <option value="Printer">M√°y in</option>
                                    <option value="Phone">ƒêi·ªán tho·∫°i</option>
                                    <option value="Other">Kh√°c</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <label class="form-label">H√£ng</label>
                                <input type="text" id="deviceBrand" class="form-control" placeholder="Dell...">
                            </div>
                            <div class="col-4">
                                <label class="form-label">Model</label>
                                <input type="text" id="deviceModel" class="form-control" placeholder="XPS 15...">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Serial / IMEI / Service Tag</label>
                            <input type="text" id="deviceSerial" class="form-control text-uppercase" placeholder="Nh·∫≠p s·ªë serial...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ph·ª• ki·ªán ƒëi k√®m</label>
                            <div class="d-flex gap-3 flex-wrap mb-2">
                                <div class="form-check">
                                    <input class="form-check-input acc-check" type="checkbox" value="S·∫°c" id="chkSac">
                                    <label class="form-check-label" for="chkSac">S·∫°c</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input acc-check" type="checkbox" value="Chu·ªôt" id="chkChuot">
                                    <label class="form-check-label" for="chkChuot">Chu·ªôt</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input acc-check" type="checkbox" value="T√∫i" id="chkTui">
                                    <label class="form-check-label" for="chkTui">T√∫i</label>
                                </div>
                            </div>
                            <input type="text" id="deviceAccessories" class="form-control form-control-sm" placeholder="Ghi ch√∫ ph·ª• ki·ªán kh√°c...">
                        </div>
                    </div>

                    <div class="col-md-6 border-start-md">
                        <h6 class="text-muted text-uppercase fw-bold mb-3">2. T√¨nh Tr·∫°ng & H√¨nh ·∫¢nh</h6>
                        <div class="mb-3">
                            <label class="form-label">M√¥ t·∫£ l·ªói (Kh√°ch b√°o) <span class="text-danger">*</span></label>
                            <textarea id="customerDesc" class="form-control" rows="3" placeholder="M√°y kh√¥ng l√™n ngu·ªìn, m√†n h√¨nh s·ªçc..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ngo·∫°i h√¨nh m√°y</label>
                            <textarea id="physicalDesc" class="form-control" rows="2" placeholder="Tr·∫ßy x∆∞·ªõc g√≥c, m√≥p v·ªè..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">H√¨nh ·∫£nh ti·∫øp nh·∫≠n</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-outline-primary dashed-border" onclick="openPhotoActionSheet('photoInput')">
                                    <i class="fas fa-camera fa-2x mb-2"></i><br>Ch·ª•p ho·∫∑c Ch·ªçn ·∫¢nh
                                </button>
                            </div>
                            <input type="file" id="photoInput_Cam" accept="image/*" capture="environment" class="d-none" onchange="handlePhotoSelect(this)">
                            <input type="file" id="photoInput_Gal" accept="image/*" multiple class="d-none" onchange="handlePhotoSelect(this)">
                            
                            <div id="photoPreviewGrid" class="photo-grid mt-3"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ghi ch√∫ n·ªôi b·ªô</label>
                            <textarea id="internalNote" class="form-control bg-light" rows="1" placeholder="L∆∞u √Ω cho k·ªπ thu·∫≠t..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white py-3 d-flex justify-content-end gap-2">
                <button class="btn btn-secondary" onclick="showView('list')">H·ªßy b·ªè</button>
                <button class="btn btn-primary" onclick="submitTicket(false)"><i class="fas fa-save"></i> L∆∞u Phi·∫øu</button>
                <button class="btn btn-success" onclick="submitTicket(true)"><i class="fas fa-print"></i> L∆∞u & In</button>
            </div>
            <div id="createSpinner" class="text-center py-2" style="display:none;">
                <div class="spinner-border text-primary" role="status"></div> <span>ƒêang x·ª≠ l√Ω...</span>
            </div>
        </div>
    </div>

    <div id="detailView" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-secondary btn-sm" onclick="showView('list')"><i class="fas fa-arrow-left"></i> Quay l·∫°i</button>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-dark btn-sm" onclick="printTicket()"><i class="fas fa-receipt"></i> In Bi√™n Nh·∫≠n</button>
                <button class="btn btn-warning btn-sm" onclick="printDeviceLabel()"><i class="fas fa-tag"></i> In Tem D√°n</button>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Th√¥ng Tin Phi·∫øu <span id="d_ticketId" class="fw-bold bg-white text-primary px-2 rounded ms-2">...</span></h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-1 text-muted small"><i class="far fa-clock"></i> Ng√†y nh·∫≠n: <span id="d_createdAt" class="text-dark">...</span></p>
                        <p class="mb-3 text-muted small"><i class="fas fa-user-tag"></i> Ng∆∞·ªùi nh·∫≠n: <span id="d_receiver" class="text-dark">...</span></p>
                        
                        <h6 class="text-primary border-bottom pb-1">Kh√°ch h√†ng</h6>
                        <p class="mb-1 fw-bold" id="d_custName">...</p>
                        <p class="mb-1 text-primary"><i class="fas fa-phone-alt"></i> <span id="d_custPhone">...</span></p>
                        <p class="small text-muted" id="d_custAddress">...</p>

                        <h6 class="text-primary border-bottom pb-1 mt-3">Thi·∫øt b·ªã</h6>
                        <p class="mb-1 fw-bold" id="d_deviceInfo">...</p>
                        <p class="mb-1 small">SN: <span id="d_deviceSerial" class="font-monospace">...</span></p>
                        <p class="mb-1 small fst-italic text-muted">PK: <span id="d_accessories">...</span></p>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white">
                        <h6 class="mb-0 text-muted">T√¨nh tr·∫°ng ban ƒë·∫ßu</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-light border mb-2">
                            <strong>Kh√°ch b√°o:</strong> <span id="d_issueDesc">...</span>
                        </div>
                        <p class="small text-muted mb-2">Ngo·∫°i h√¨nh: <span id="d_physicalDesc">...</span></p>
                        
                        <h6 class="small text-muted mt-3">·∫¢nh ti·∫øp nh·∫≠n:</h6>
                        <div id="d_receivePhotos" class="photo-grid"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body p-3">
                        <div class="timeline-wrapper">
                            <div class="timeline-steps">
                                <div class="step active" id="step_new"><div class="step-circle">1</div><div class="step-label">Ti·∫øp nh·∫≠n</div></div>
                                <div class="step" id="step_check"><div class="step-circle">2</div><div class="step-label">Ki·ªÉm tra</div></div>
                                <div class="step" id="step_quote"><div class="step-circle">3</div><div class="step-label">B√°o gi√°</div></div>
                                <div class="step" id="step_repair"><div class="step-circle">4</div><div class="step-label">S·ª≠a ch·ªØa</div></div>
                                <div class="step" id="step_done"><div class="step-circle">5</div><div class="step-label">Ho√†n t·∫•t</div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="vstack gap-3">
                    
                    <div class="card shadow-sm border-0" id="block_techCheck">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-primary fw-bold"><i class="fas fa-stethoscope"></i> K·ªπ Thu·∫≠t Ki·ªÉm Tra</h6>
                            <button id="btn_update_check" class="btn btn-sm btn-outline-primary" onclick="openUpdateModal('check')">C·∫≠p nh·∫≠t</button>
                        </div>
                        <div class="card-body" id="content_techCheck">...</div>
                    </div>

                    <div class="card shadow-sm border-0 border-warning" id="block_external_logistics" style="display:none; background-color: #fffaf0;">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h6 class="mb-0 text-warning fw-bold"><i class="fas fa-truck"></i> ƒêi·ªÅu Ph·ªëi G·ª≠i Ngo√†i</h6>
                        </div>
                        <div class="card-body" id="content_external_logistics">...</div>
                    </div>

                    <div class="card shadow-sm border-0" id="block_quotation">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-success fw-bold"><i class="fas fa-file-invoice-dollar"></i> B√°o Gi√° S·ª≠a Ch·ªØa</h6>
                            <button id="btn_update_quote" class="btn btn-sm btn-success" onclick="openUpdateModal('quote')">L√™n B√°o Gi√°</button>
                        </div>
                        <div class="card-body" id="content_quotation">...</div>
                    </div>

                    <div class="card shadow-sm border-0" id="block_repair">
                        <div class="card-header bg-white">
                            <h6 class="mb-0 text-info fw-bold"><i class="fas fa-wrench"></i> Qu√° Tr√¨nh S·ª≠a Ch·ªØa</h6>
                        </div>
                        <div class="card-body" id="content_repair">...</div>
                    </div>

                    <div class="card shadow-sm border-0" id="block_payment">
                        <div class="card-header bg-white">
                            <h6 class="mb-0 text-dark fw-bold"><i class="fas fa-cash-register"></i> Tr·∫£ M√°y & Thanh To√°n</h6>
                        </div>
                        <div class="card-body" id="content_payment">...</div>
                    </div>

                </div>
            </div>
        </div>
    </div>

  </div> <div class="modal fade" id="ticketQrModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Qu√©t M√£ Phi·∫øu</h5>
                <button type="button" class="btn-close" onclick="stopTicketQrScanner()"></button>
            </div>
            <div class="modal-body text-center p-0">
                <div id="ticket-qr-reader" style="width:100%;"></div>
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn btn-secondary btn-sm" onclick="stopTicketQrScanner()">ƒê√≥ng</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalTechCheck" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-stethoscope"></i> C·∫≠p Nh·∫≠t K·∫øt Qu·∫£ Ki·ªÉm Tra</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Nguy√™n nh√¢n l·ªói (*)</label>
                    <textarea id="check_cause" class="form-control" rows="3" placeholder="VD: Mainboard b·ªã ch·∫°m ngu·ªìn..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">ƒê·ªÅ xu·∫•t x·ª≠ l√Ω</label>
                    <select id="check_solution" class="form-select">
                        <option value="S·ª≠a ch·ªØa">S·ª≠a ch·ªØa / Thay th·∫ø</option>
                        <option value="C√†i ƒë·∫∑t">C√†i ƒë·∫∑t ph·∫ßn m·ªÅm</option>
                        <option value="G·ª≠i s·ª≠a ngo√†i">G·ª≠i s·ª≠a ngo√†i</option>
                        <option value="G·ª≠i h√£ng">G·ª≠i b·∫£o h√†nh h√£ng</option>
                        <option value="Kh√¥ng s·ª≠a ƒë∆∞·ª£c">Tr·∫£ m√°y (Kh√¥ng s·ª≠a ƒë∆∞·ª£c)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Linh ki·ªán c·∫ßn thay (n·∫øu c√≥)</label>
                    <textarea id="check_components" class="form-control" rows="2" placeholder="VD: M√†n h√¨nh 14 inch..."></textarea>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm w-100 dashed-border" onclick="openPhotoActionSheet('checkPhotoInput')">
                    <i class="fas fa-camera"></i> Th√™m ·∫£nh ki·ªÉm tra
                </button>
                <div id="checkPhotoGrid" class="photo-grid mt-2"></div>
                <input type="file" id="checkPhotoInput_Cam" accept="image/*" capture="environment" class="d-none" onchange="handleCheckPhotoSelect(this)">
                <input type="file" id="checkPhotoInput_Gal" accept="image/*" multiple class="d-none" onchange="handleCheckPhotoSelect(this)">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="submitTechCheck()">L∆∞u K·∫øt Qu·∫£</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalQuote" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-file-invoice-dollar"></i> L√™n B√°o Gi√° Chi Ti·∫øt</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 p-3 bg-light rounded border">
                    <label class="form-label fw-bold d-block">H√¨nh th·ª©c x·ª≠ l√Ω:</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="quoteType" id="qTypeInternal" value="INTERNAL" checked onchange="toggleQuoteType()">
                        <label class="btn btn-outline-primary" for="qTypeInternal">S·ª≠a t·∫°i ch·ªó</label>
                        
                        <input type="radio" class="btn-check" name="quoteType" id="qTypeExternal" value="EXTERNAL" onchange="toggleQuoteType()">
                        <label class="btn btn-outline-warning text-dark" for="qTypeExternal">G·ª≠i ƒë∆°n v·ªã ngo√†i</label>
                    </div>
                </div>

                <div id="ext_unit_div" class="mb-3 ext-only">
                    <label class="form-label fw-bold text-warning">T√™n ƒë∆°n v·ªã s·ª≠a ch·ªØa / H√£ng:</label>
                    <input type="text" id="q_ext_unit" class="form-control border-warning" placeholder="VD: Trung t√¢m b·∫£o h√†nh Dell...">
                </div>

                <div class="alert alert-info py-2 small mb-3">
                    <strong>ƒê·ªÅ xu·∫•t t·ª´ KTV:</strong> <span id="quote_tech_summary">...</span>
                </div>

                <div class="table-responsive mb-3">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>T√™n linh ki·ªán / D·ªãch v·ª•</th>
                                <th style="width: 70px;">SL</th>
                                <th class="ext-only text-warning" style="width: 120px;">Gi√° G·ªëc (A)</th>
                                <th class="text-success" style="width: 120px;">Gi√° B√°n (B)</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="quoteItemsBody"></tbody>
                    </table>
                    <button class="btn btn-sm btn-outline-secondary" onclick="addQuoteRow()">+ Th√™m d√≤ng</button>
                </div>

                <div id="ext_ship_div" class="ext-only row justify-content-end align-items-center mb-2">
                    <label class="col-auto col-form-label text-muted">+ Ph√≠ v·∫≠n chuy·ªÉn (N·ªôi b·ªô):</label>
                    <div class="col-auto">
                        <input type="number" id="q_ext_ship" class="form-control form-control-sm text-end" style="width:120px;" placeholder="0" oninput="calculateQuoteTotal()">
                    </div>
                </div>

                <div class="card bg-light border mb-3">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fs-5">T·ªïng B√°o Kh√°ch (B):</span>
                            <strong id="quote_total_display" class="fs-4 text-success">0 ƒë</strong>
                        </div>
                        <div id="profit_display_div" class="ext-only border-top mt-2 pt-2 d-flex justify-content-between text-muted small">
                            <span>L·ª£i nhu·∫≠n d·ª± ki·∫øn (B - A - Ship):</span>
                            <strong id="quote_profit_display" class="text-warning">0 ƒë</strong>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">B·∫£o h√†nh:</label>
                        <input type="text" id="quote_warranty" class="form-control" placeholder="VD: 3 th√°ng...">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Ghi ch√∫ th√™m:</label>
                        <textarea id="quote_notes" class="form-control" rows="1" placeholder="VD: Gi√° ch∆∞a VAT..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" onclick="submitQuote()">G·ª≠i B√°o Gi√°</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalRepair" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle"></i> B√°o C√°o Ho√†n T·∫•t S·ª≠a Ch·ªØa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">C√¥ng vi·ªác ƒë√£ th·ª±c hi·ªán (*):</label>
                    <textarea id="repair_work" class="form-control" rows="4" placeholder="VD: ƒê√£ thay IC ngu·ªìn, v·ªá sinh mainboard, test full ch·ª©c nƒÉng..."></textarea>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm w-100 dashed-border" onclick="openPhotoActionSheet('repairPhotoInput')">
                    <i class="fas fa-camera"></i> Th√™m ·∫£nh sau khi s·ª≠a
                </button>
                <div id="repairPhotoGrid" class="photo-grid mt-2"></div>
                <input type="file" id="repairPhotoInput_Cam" accept="image/*" capture="environment" class="d-none" onchange="handleRepairPhotoSelect(this)">
                <input type="file" id="repairPhotoInput_Gal" accept="image/*" multiple class="d-none" onchange="handleRepairPhotoSelect(this)">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-info text-white" onclick="submitRepairComplete()">X√°c nh·∫≠n S·ª≠a Xong</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalReturn" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-hand-holding-usd"></i> Thanh To√°n & Tr·∫£ M√°y</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success d-flex justify-content-between align-items-center mb-3">
                    <span>T·ªïng ti·ªÅn kh√°ch ph·∫£i tr·∫£:</span>
                    <strong id="return_quote_price" class="fs-4">0 ƒë</strong>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label fw-bold">Th·ª±c thu (VNƒê) (*)</label>
                        <input type="number" id="return_amount" class="form-control fw-bold text-success" placeholder="Nh·∫≠p s·ªë ti·ªÅn...">
                    </div>
                    <div class="col-6">
                        <label class="form-label">H√¨nh th·ª©c (*)</label>
                        <select id="return_method" class="form-select">
                            <option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t</option>
                            <option value="Chuy·ªÉn kho·∫£n">Chuy·ªÉn kho·∫£n</option>
                            <option value="C√¥ng n·ª£">C√¥ng n·ª£</option>
                            <option value="Kh√¥ng thu ti·ªÅn">Kh√¥ng thu ti·ªÅn</option>
                            <option value="Kh√°c">Kh√°c</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">S·ªë s·ªï 3 li√™n (B·∫Øt bu·ªôc):</label>
                    <input type="text" id="return_ticket_number" class="form-control" placeholder="VD: 001234">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ghi ch√∫ b√†n giao:</label>
                    <textarea id="return_note" class="form-control" rows="2" placeholder="VD: Kh√°ch ƒë√£ ki·ªÉm tra m√°y ok..."></textarea>
                </div>

                <button type="button" class="btn btn-outline-secondary btn-sm w-100 dashed-border" onclick="openPhotoActionSheet('returnPhotoInput')">
                    <i class="fas fa-camera"></i> ·∫¢nh b√†n giao (S·ªï/H√≥a ƒë∆°n)
                </button>
                <div id="returnPhotoGrid" class="photo-grid mt-2"></div>
                <input type="file" id="returnPhotoInput_Cam" accept="image/*" capture="environment" class="d-none" onchange="handleReturnPhotoSelect(this)">
                <input type="file" id="returnPhotoInput_Gal" accept="image/*" multiple class="d-none" onchange="handleReturnPhotoSelect(this)">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" onclick="submitReturnDevice()">Ho√†n t·∫•t & Tr·∫£ M√°y</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalExtSend" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark">üöö G·ª≠i M√°y ƒêi S·ª≠a Ngo√†i</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>X√°c nh·∫≠n g·ª≠i m√°y cho ƒë∆°n v·ªã ƒë·ªëi t√°c?</p>
                <div class="mb-3">
                    <label class="form-label fw-bold">ƒê∆°n v·ªã ti·∫øp nh·∫≠n:</label>
                    <input type="text" id="ext_send_unit" class="form-control" placeholder="Nh·∫≠p t√™n c·ª≠a h√†ng/h√£ng...">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ghi ch√∫ g·ª≠i h√†ng:</label>
                    <textarea id="ext_send_note" class="form-control" rows="2" placeholder="VD: G·ª≠i k√®m s·∫°c..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-warning text-dark" onclick="submitExternalAction('SEND')">X√°c nh·∫≠n G·ª≠i</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalExtReceive" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">‚úÖ Nh·∫≠n M√°y & Ki·ªÉm Tra (QC)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>M√°y ƒë√£ ƒë∆∞·ª£c g·ª≠i tr·∫£ v·ªÅ. K·ªπ thu·∫≠t vi√™n c·∫ßn ki·ªÉm tra l·∫°i.</p>
                <div class="mb-3">
                    <label class="form-label fw-bold">K·∫øt qu·∫£ ki·ªÉm tra (QC):</label>
                    <select id="ext_qc_result" class="form-select">
                        <option value="PASS">ƒê·∫°t - M√°y ho·∫°t ƒë·ªông t·ªët</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Ghi ch√∫ ki·ªÉm tra:</label>
                    <textarea id="ext_qc_note" class="form-control" rows="3" placeholder="VD: ƒê√£ test full ch·ª©c nƒÉng, tem b·∫£o h√†nh nguy√™n v·∫πn..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" onclick="submitExternalAction('RECEIVE_PASS')">QC ƒê·∫°t - Nh·∫≠p Kho</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalAssign" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üëâ Ph√¢n C√¥ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted">Ch·ªçn nh√¢n s·ª± th·ª±c hi·ªán:</p>
                <select id="assign_tech_select" class="form-select">
                    <option value="">-- ƒêang t·∫£i... --</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="submitAssignWork()">Giao Vi·ªác</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="photoActionSheet" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body p-0">
                <div class="list-group list-group-flush text-center">
                    <button class="list-group-item list-group-item-action py-3 text-primary fw-bold" onclick="triggerPhotoInput('cam')">üì∑ Ch·ª•p ·∫£nh m·ªõi</button>
                    <button class="list-group-item list-group-item-action py-3 text-primary fw-bold" onclick="triggerPhotoInput('gal')">üñºÔ∏è Ch·ªçn t·ª´ th∆∞ vi·ªán</button>
                    <button class="list-group-item list-group-item-action py-3 text-secondary" data-bs-dismiss="modal">H·ªßy b·ªè</button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div id="imageViewerModal" class="image-modal" onclick="closeImageModal()">
    <span class="close-img">&times;</span>
    <img class="image-modal-content" id="imgExpanded">
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script src="common.js"></script>
  <script src="repair.js"></script>
</body>
</html>